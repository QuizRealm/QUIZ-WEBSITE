<!DOCTYPE html>
<html lang="en">
<head>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-ML3F7KLZ');</script>
<script type="module" src="firebase-config.js"></script>
 <script type="module" src="game-engine.js"></script> <script src="components.js" defer></script> 
<link rel="icon" type="image/png" sizes="192x192" href="assets/favicon-192.png">
<meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizRealm â€¢ Quiz Session</title>
        <link rel="manifest" href="assets/site.webmanifest">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">
    <meta name="theme-color" content="#0A0F1E">

    <meta name="description" content="Play a fast, focused trivia session and track your score and streak.">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
<link rel="manifest" href="assets/site.webmanifest">
<link rel="shortcut icon" href="assets/favicon.ico">
<meta name="msapplication-TileColor" content="#020617">
<meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@300;400;500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="data.js"></script>
    <script src="facts.js"></script>
    <script src="components.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'], 
                        arcade: ['Bungee', 'cursive'],
                        mono: ['Share Tech Mono', 'monospace']
                    },
                    colors: {
                        bgDark: '#0A0F1E',
                        bgDarker: '#050810',
                        accentBlue: '#3b82f6',
                        accentCyan: '#06b6d4',
                        accentGreen: '#10b981',
                        accentOrange: '#f97316',
                        accentRed: '#ef4444',
                        accentGold: '#eab308',
                        glass: 'rgba(30, 41, 59, 0.7)'
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.5)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: var(--bgDarker); 
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b, #050810 80%);
            min-height: 100vh; 
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        .grid-bg { 
            background-size: 60px 60px; 
            background-image: linear-gradient(to right, rgba(59, 130, 246, 0.03) 1px, transparent 1px), 
                                     linear-gradient(to bottom, rgba(59, 130, 246, 0.03) 1px, transparent 1px); 
            mask-image: linear-gradient(to bottom, black 20%, transparent 90%); 
        }

        .glass-panel { 
            background: var(--glass); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Option Buttons */
        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .option-btn:hover:not(:disabled) {
            transform: translateX(8px);
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }
        .option-btn.correct {
            background: rgba(16, 185, 129, 0.3) !important;
            border-color: #10b981 !important;
            color: #10b981 !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        .option-btn.wrong {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
            opacity: 0.6;
        }

        .power-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .power-btn:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .timer-bar { transition: width 1s linear; }
        .fade-enter { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col antialiased selection:bg-accentBlue selection:text-white">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-ML3F7KLZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="fixed inset-0 grid-bg pointer-events-none z-[-1]"></div>

    <header class="sticky top-0 z-50 glass-panel border-b border-white/5 backdrop-blur-xl">
        <div class="max-w-[1400px] mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-2 group">
                    <i class="fas fa-ghost text-2xl text-accentBlue"></i>
                    <div class="font-arcade text-lg tracking-widest text-white hidden md:block">QUIZ<span class="text-accentBlue">REALM</span></div>
                </a>
            </div>

            <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-black/40 px-6 py-1 rounded-b-xl border-b border-l border-r border-white/10 shadow-lg">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Time</span>
                    <span class="text-xl font-mono font-bold text-white" id="timerDisplay">00</span>
                </div>
                <div class="w-px h-4 bg-white/20"></div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Score</span>
                    <span class="text-xl font-mono font-bold text-accentGreen" id="scoreDisplay">0</span>
                </div>
            </div>

            <button onclick="quitQuiz()" class="text-[10px] font-bold text-red-400 hover:text-red-300 transition flex items-center gap-2 border border-red-500/30 px-3 py-1.5 rounded-lg hover:bg-red-500/10">
                EXIT QUIZ
            </button>
        </div>
        <div class="w-full h-1 bg-black/50">
            <div id="timeBar" class="h-full bg-accentCyan timer-bar shadow-[0_0_10px_rgba(6,182,212,0.8)]" style="width: 100%"></div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-[1400px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 relative">

        <div class="lg:col-span-8 space-y-4 relative">
            <div id="quizCard" class="glass-panel rounded-2xl p-6 md:p-10 border-t-4 border-t-accentBlue min-h-[450px] flex flex-col justify-between relative overflow-hidden fade-enter">
                
                <div id="streakContainer" class="absolute top-0 right-0 p-4 opacity-0 transition-opacity duration-500">
                    <div class="flex items-center gap-1 bg-orange-500/10 border border-orange-500/30 px-3 py-1 rounded-full animate-pulse-fast">
                        <i class="fas fa-fire text-accentOrange text-lg"></i>
                        <span class="text-sm font-bold text-accentOrange font-mono">x<span id="streakCount">0</span></span>
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-6">
                    <span class="bg-accentBlue/20 text-accentBlue text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">Question Info</span>
                    <span class="text-xs text-slate-500 font-mono">Q <span id="qIndex">1</span> / <span id="qTotal">10</span></span>
                </div>

                <h2 id="questionText" class="text-2xl md:text-3xl font-bold text-white leading-tight mb-8 relative z-10 min-h-[90px]">
                    Loading questionâ€¦
                </h2>

                <div id="optionsContainer" class="grid grid-cols-1 gap-3 relative z-10"></div>

                <div id="feedbackOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-md z-50 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">
                    <div id="feedbackIcon" class="text-7xl mb-4 animate-bounce"></div>
                    <h3 id="feedbackText" class="text-3xl font-arcade text-white mb-2"></h3>
                    <p id="feedbackSub" class="text-sm text-slate-400 mb-8 font-mono"></p>
                    <button id="nextBtn" class="bg-white text-black hover:bg-accentBlue hover:text-white px-10 py-3 rounded-xl font-bold text-lg shadow-xl transition flex items-center gap-2">
                        NEXT QUESTION <i class="fas fa-forward"></i>
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 flex justify-center items-center gap-4">
                <button onclick="usePowerup('fifty')" id="btn5050" class="power-btn w-full md:w-auto bg-black/40 hover:bg:white/5 border border-white/10 rounded-lg py-3 px-6 flex items-center justify-center gap-2 transition">
                    <i class="fas fa-cut text-indigo-400"></i> <span class="text-xs font-bold text-slate-300 uppercase">50/50</span>
                </button>
                <button onclick="usePowerup('time')" id="btnTime" class="power-btn w-full md:w-auto bg-black/40 hover:bg-white/5 border border-white/10 rounded-lg py-3 px-6 flex items-center justify-center gap-2 transition">
                    <i class="fas fa-clock text-green-400"></i> <span class="text-xs font-bold text-slate-300 uppercase">+15s</span>
                </button>
                <button onclick="usePowerup('skip')" id="btnSkip" class="power-btn w-full md:w-auto bg-black/40 hover:bg-white/5 border border-white/10 rounded-lg py-3 px-6 flex items-center justify-center gap-2 transition">
                    <i class="fas fa-fast-forward text-orange-400"></i> <span class="text-xs font-bold text-slate-300 uppercase">Skip</span>
                </button>
            </div>
        </div>

        <aside class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-xl overflow-hidden border border-accentCyan/30 relative group">
                <div class="bg-accentCyan/10 p-2 border-b border-accentCyan/20 flex items-center gap-2">
                    <i class="fas fa-database text-accentCyan text-xs"></i>
                    <span class="text-[10px] font-bold text-accentCyan uppercase tracking-widest">Extra Context</span>
                </div>
                <div class="relative h-40 w-full overflow-hidden">
                    <img id="factImg1" src="" class="absolute inset-0 w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-gradient-to-t from-bgDarker via-transparent to-transparent"></div>
                    <div class="absolute bottom-2 left-2 right-2">
                        <h4 class="text-white font-bold text-sm leading-tight drop-shadow-md" id="factTitle1">Loading...</h4>
                    </div>
                </div>
                <div class="p-3 bg-black/20">
                    <p class="text-xs text-slate-300 leading-relaxed line-clamp-3" id="factBody1">...</p>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-4 border-l-4 border-l-accentPurple relative">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-accentPurple uppercase">Did You Know?</span>
                    <i class="fas fa-terminal text-slate-600 text-xs"></i>
                </div>
                <p class="text-xs text-slate-400 font-mono leading-relaxed" id="factBody2">Loading secondary data stream...</p>
            </div>
        </aside>
    </main>
    
    <div class="w-full max-w-[1400px] mx-auto px-6 pt-10 pb-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <div class="glass-panel rounded-xl p-5 border-l-4 border-l-accentBlue">
                <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-3">Quiz Overview</h3>
                <p class="text-xs text-slate-300 leading-relaxed">
                    This is a timed quiz session. Each correct answer increases your score and experience points. Use the power-ups (50/50, +15s, Skip) to help you when you are unsure, and try to build a long streak of correct answers.
                </p>
                <div class="text-[10px] text-slate-500 font-mono mt-3">Difficulty: <span id="missionDifficulty">OPERATIVE</span></div>
            </div>

            <div class="glass-panel rounded-xl p-5 border-l-4 border-l-accentGreen lg:col-span-2">
                <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i class="fas fa-book-reader text-accentGreen"></i> How This Quiz Works
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs text-slate-300">
                    <div>
                        <span class="font-bold text-white block mb-1">Timing & Score</span>
                        <ul class="space-y-1 list-disc list-inside ml-2">
                            <li>Higher difficulty can mean less time.</li>
                            <li>Your score grows with each correct answer.</li>
                        </ul>
                    </div>
                    <div>
                        <span class="font-bold text-white block mb-1">Streaks & XP</span>
                        <ul class="space-y-1 list-disc list-inside ml-2">
                            <li>3+ correct answers in a row activates a visible streak.</li>
                            <li>Any wrong answer resets your streak to 0.</li>
                        </ul>
                    </div>
                    <div>
                        <span class="font-bold text-white block mb-1">End of Quiz</span>
                        <ul class="space-y-1 list-disc list-inside ml-2">
                            <li>The timer reaching 0 counts as a wrong answer.</li>
                            <li>The session ends after all questions are answered.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="glass-panel rounded-xl p-5 border-l-4 border-l-accentGold">
                <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i class="fas fa-gamepad text-accentGold"></i> More Games
                </h3>
                <div class="space-y-2">
                    <a href="timeline-history.html" class="flex items-center gap-3 p-2 bg-black/30 rounded hover:bg-black/50 transition">
                        <i class="fas fa-hourglass-half text-accentGold"></i>
                        <span class="text-xs font-bold text-white">History Timeline</span>
                    </a>
                     <a href="rapid.html" class="flex items-center gap-3 p-2 bg-black/30 rounded hover:bg-black/50 transition">
                        <i class="fas fa-stopwatch text-accentRed"></i>
                        <span class="text-xs font-bold text-white">Rapid Fire Mode</span>
                    </a>
                    <a href="minigames.html" class="flex items-center gap-3 p-2 bg-black/30 rounded hover:bg-black/50 transition">
                        <i class="fas fa-pencil-alt text-accentPink"></i>
                        <span class="text-xs font-bold text-white">Pictionary</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
    
    <div id="resultsModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-xl hidden flex-col items-center justify-center p-4">
        <div class="glass-panel border-2 border-accentBlue/30 rounded-3xl p-8 max-w-md w-full text-center relative overflow-hidden animate-pop-in">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-32 bg-accentBlue/20 rounded-full blur-[80px] -z-10"></div>
            
            <i class="fas fa-flag-checkered text-5xl text-white mb-4 drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]"></i>
            <h2 class="text-4xl font-arcade text-white mb-2 uppercase tracking-wide">Quiz<br>Complete</h2>
            <p class="text-slate-400 text-sm mb-8">Hereâ€™s your quiz summary.</p>
            
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-black/40 p-3 rounded-xl border border-white/5">
                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Score</div>
                    <div class="text-xl font-mono text-accentGreen" id="resScore">0</div>
                </div>
                <div class="bg-black/40 p-3 rounded-xl border border-white/5">
                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Best Streak</div>
                    <div class="text-xl font-mono text-accentOrange" id="resStreak">0</div>
                </div>
                <div class="bg-black/40 p-3 rounded-xl border border-white/5">
                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">XP</div>
                    <div class="text-xl font-mono text-accentBlue" id="resXP">0</div>
                </div>
            </div>

            <div id="unlockSection" class="hidden mb-8 text-left">
                <h3 class="text-xs font-bold text-accentGold uppercase mb-2 tracking-wider flex items-center gap-2">
                    <i class="fas fa-unlock"></i> New Achievements
                </h3>
                <div id="unlockContainer" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="space-y-3">
                <button onclick="location.reload()" class="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-accentBlue hover:text-white transition shadow-lg flex items-center justify-center gap-2 group">
                    <i class="fas fa-redo group-hover:rotate-180 transition-transform"></i> PLAY AGAIN
                </button>
                <button onclick="location.href='index.html'" class="w-full py-4 bg-black/40 text-slate-300 font-bold rounded-xl hover:bg-white/10 hover:text-white border border-white/10 transition">
                    BACK TO HOME
                </button>
            </div>
        </div>
    </div>

    <quiz-footer></quiz-footer>

    <script>
        // --- GAME CONFIG & STATE ---
        const TIME_LIMIT = 30; 
        let questions = [], index = 0, score = 0, streak = 0, maxStreak = 0, timer = TIME_LIMIT;
        let timerInterval;
        let powerups = { fifty: true, time: true, skip: true };
        let activeCategory = 'general';
        let currentDifficulty = 'EASY'; 
        let fastCorrectCount = 0;
        let wrongCount = 0;
        let questionResults = [];
        let startTime = Date.now(); // Track total session time
        
        // --- NEW TRACKING VARIABLES ---
        let questionStartTime = 0;
        let totalReactionTime = 0;
        let ghostClickCount = 0;
        let validClickCount = 0;

        // --- NEW: GHOST CLICK TRACKER ---
        document.addEventListener('click', (e) => {
            // If they click something that is NOT a button or link, count it as a ghost click
            if (e.target.closest('button') || e.target.closest('a') || e.target.closest('.option-btn') || e.target.closest('.power-btn')) {
                validClickCount++;
            } else {
                ghostClickCount++;
            }
        });

        // --- INIT ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            activeCategory = (params.get('category') || 'general').toLowerCase();
            const difficulty = (params.get('difficulty') || 'easy').toLowerCase();
            
            currentDifficulty = difficulty.toUpperCase();
            document.getElementById('missionDifficulty').textContent = currentDifficulty;

            loadQuestions(activeCategory, difficulty);
            loadSidebarContent();
        }

        // --- LOADING LOGIC ---
        function loadQuestions(cat, diff) {
            if (typeof QUESTION_BANKS === "undefined" || !QUESTION_BANKS[cat]) {
                // Fallback / Demo
                questions = [
                    {question: "Demo: What is 2+2?", options: ["3","4","5","6"], correctIndex: 1},
                    {question: "Demo: Sky color?", options: ["Red","Green","Blue","Yellow"], correctIndex: 2},
                    {question: "Demo: Capital of UK?", options: ["London","Paris","Rome","Berlin"], correctIndex: 0}
                ];
            } else {
                const bank = QUESTION_BANKS[cat];
                let pool = Array.isArray(bank) ? bank : (bank[diff] || bank['easy']);
                questions = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
            }
            
            if(questions.length === 0) questions = [{question: "Error loading data.", options:["Ok"], correctIndex:0}];

            document.getElementById('qTotal').textContent = questions.length;
            renderQuestion();
        }

        function loadSidebarContent() {
            if (typeof quizFacts === 'undefined' || Object.keys(quizFacts).length === 0) {
                document.getElementById('factBody2').textContent = `Fact database offline.`;
                return;
            }
            
            let factPool = quizFacts[activeCategory] || [];
            if(factPool.length === 0) Object.keys(quizFacts).forEach(k => factPool = factPool.concat(quizFacts[k]));
            if (factPool.length > 0) {
                const f1 = factPool[Math.floor(Math.random() * factPool.length)];
                document.getElementById('factTitle1').textContent = f1.title || "Did You Know?";
                document.getElementById('factBody1').textContent = f1.body || "Loading...";
                document.getElementById('factImg1').src = f1.image || "https://via.placeholder.com/300x200";
            }
        }

        // --- GAMEPLAY ---
        function shuffleArray(array) {
            let newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function renderQuestion() {
            clearInterval(timerInterval);
            timer = TIME_LIMIT;
            updateTimerUI();
            startTimer();
            
            // --- NEW: START REACTION TIMER FOR THIS QUESTION ---
            questionStartTime = Date.now();

            if (index >= questions.length) {
                endGame();
                return;
            }

            const q = questions[index];
            document.getElementById('qIndex').textContent = index + 1;
            document.getElementById('questionText').textContent = q.question;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const card = document.getElementById('quizCard');
            card.classList.remove('fade-enter');
            void card.offsetWidth; 
            card.classList.add('fade-enter');

            const originalCorrectAnswer = q.options[q.correctIndex];
            const shuffledOptions = shuffleArray(q.options);
            q.shuffledCorrectIndex = shuffledOptions.findIndex(opt => opt === originalCorrectAnswer);

            shuffledOptions.forEach((opt, i) => { 
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-xl bg-white/5 border border-white/10 text-slate-200 font-medium text-sm md:text-base";
                btn.innerHTML = `<span class="inline-block w-6 text-slate-500 font-mono">${String.fromCharCode(65+i)}.</span> ${opt}`;
                btn.onclick = () => handleAnswer(i, btn); 
                container.appendChild(btn);
            });
        }

        function handleAnswer(selectedIndex, btn) {
            // --- NEW: CALCULATE REACTION TIME ---
            const timeTaken = Date.now() - questionStartTime;
            totalReactionTime += timeTaken;

            clearInterval(timerInterval);
            const q = questions[index];
            const isCorrect = selectedIndex === q.shuffledCorrectIndex;
            const timeUsed = TIME_LIMIT - timer;
            
            const correctBtn = document.getElementById('optionsContainer').children[q.shuffledCorrectIndex];
            Array.from(document.getElementById('optionsContainer').children).forEach(b => b.disabled = true);

            if (isCorrect) {
                if (btn) btn.classList.add('correct');
                score++;
                streak++;
                if(streak > maxStreak) maxStreak = streak;
                questionResults[index] = true;
                if (timeUsed <= 10) fastCorrectCount++;
                
                // INSTANT XP REWARD (Small amount per question)
                if (window.GameEngine) GameEngine.addXP(10); 

            } else {
                if(btn) btn.classList.add('wrong');
                if(correctBtn) correctBtn.classList.add('correct');
                streak = 0;
                wrongCount++;
                questionResults[index] = false;
                const card = document.getElementById('quizCard');
                card.classList.add('animate-shake');
                setTimeout(()=>card.classList.remove('animate-shake'), 500);
            }
            updateHUD();
            
            setTimeout(() => {
                showFeedback(isCorrect, correctBtn.textContent.substring(4).trim()); 
            }, 800);
        }

        function showFeedback(isCorrect, rightAnswer) {
            const overlay = document.getElementById('feedbackOverlay');
            overlay.classList.remove('hidden');
            void overlay.offsetWidth;
            overlay.style.opacity = '1';

            const icon = document.getElementById('feedbackIcon');
            const title = document.getElementById('feedbackText');
            const sub = document.getElementById('feedbackSub');
            const nextBtn = document.getElementById('nextBtn');

            if (isCorrect) {
                icon.innerHTML = 'ðŸŽ‰';
                title.textContent = "Correct!";
                title.className = "text-4xl font-arcade text-accentGreen mb-2";
                sub.textContent = `Current streak: ${streak}`;
            } else {
                icon.innerHTML = 'ðŸ’€';
                title.textContent = "Incorrect";
                title.className = "text-4xl font-arcade text-accentRed mb-2";
                sub.textContent = `Correct answer: ${rightAnswer}`;
            }

            nextBtn.onclick = () => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 300);
                index++;
                renderQuestion();
            };
        }

        function updateHUD() {
            document.getElementById('scoreDisplay').textContent = score * 100;
            const sCont = document.getElementById('streakContainer');
            document.getElementById('streakCount').textContent = streak;
            sCont.style.opacity = streak >= 3 ? '1' : '0';
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer--;
                updateTimerUI();
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1, null);
                }
            }, 1000);
        }

        function updateTimerUI() {
            document.getElementById('timerDisplay').textContent = timer < 10 ? `0${timer}` : timer;
            const pct = (timer / TIME_LIMIT) * 100;
            const bar = document.getElementById('timeBar');
            bar.style.width = `${pct}%`;
            if (pct < 30) { 
                bar.classList.remove('bg-accentCyan'); 
                bar.classList.add('bg-accentRed'); 
            } else { 
                bar.classList.add('bg-accentCyan'); 
                bar.classList.remove('bg-accentRed'); 
            }
        }

        // --- ENDGAME LOGIC (UPDATED WITH SAVE) ---
        function endGame() {
            const totalQuestions = questions.length || 1;
            const finalPercent = (score / totalQuestions) * 100;
            const totalTime = (Date.now() - startTime) / 1000;
            
            // Calculate Average Speed
            const questionsAnswered = index; // How many they actually did
            const avgTime = questionsAnswered > 0 ? Math.round(totalReactionTime / questionsAnswered) : 0;

            // 1. CALCULATE REWARDS
            let xpEarned = score * 50; // 50 XP per right answer
            if (finalPercent === 100) xpEarned += 500; // Perfect Bonus
            if (maxStreak >= 5) xpEarned += 200; // Streak Bonus

            // 2. SEND TO ENGINE
            if (window.GameEngine) {
                // Add the big bulk XP (Animation happens here)
                window.GameEngine.addXP(xpEarned);
                
                // Unlock Achievements
                checkAchievements(finalPercent, activeCategory, totalTime);
                
                // --- NEW: SAVE FULL GAME RESULT TO DB ---
                window.GameEngine.saveGameResult(
                    "Standard Quiz (" + activeCategory + ")", 
                    score, 
                    totalQuestions, 
                    {
                        avgTime: avgTime,
                        ghostClicks: ghostClickCount,
                        difficulty: currentDifficulty
                    }
                );
            }

            // 3. SHOW UI
            document.getElementById('resultsModal').classList.remove('hidden');
            document.getElementById('resultsModal').classList.add('flex');
            
            document.getElementById('resScore').textContent = `${Math.round(finalPercent)}%`;
            document.getElementById('resStreak').textContent = maxStreak;
            document.getElementById('resXP').textContent = `+${xpEarned}`;
        }

        function checkAchievements(percent, cat, time) {
            if (!window.GameEngine) return;
            const E = window.GameEngine;

            // General
            E.unlockAchievement("new_recruit");
            if (percent === 100) E.unlockAchievement("perfect_score");
            if (time < 60) E.unlockAchievement("speed_runner");
            if (maxStreak >= 7) E.unlockAchievement("streak_7");

            // Category Specific
            if (cat === 'science' && percent >= 80) E.unlockAchievement("science_whiz");
            if (cat === 'history' && percent >= 80) E.unlockAchievement("history_buff");
            if (cat === 'movies' && percent >= 80) E.unlockAchievement("cinephile");
            
            // Hardcore
            if (currentDifficulty === 'HARD' && percent === 100) E.unlockAchievement("legendary_status");
        }

        // --- POWERUPS ---
        function usePowerup(type) {
            if (!powerups[type]) return;
            const btn = document.getElementById(type === 'fifty' ? 'btn5050' : type === 'time' ? 'btnTime' : 'btnSkip');
            btn.disabled = true;
            powerups[type] = false;

            if (type === 'fifty') {
                const q = questions[index];
                const opts = Array.from(document.getElementById('optionsContainer').children);
                let removed = 0;
                opts.forEach((b, i) => {
                    if (removed < 2 && i !== q.shuffledCorrectIndex) {
                        b.style.opacity = '0.2';
                        b.disabled = true;
                        removed++;
                    }
                });
            } else if (type === 'time') {
                timer += 15;
                updateTimerUI();
            } else if (type === 'skip') {
                clearInterval(timerInterval);
                index++;
                renderQuestion();
            }
        }

        function quitQuiz() {
            if(confirm("Exit this quiz? Your progress in this session will be lost.")) {
                window.location.href = 'categories.html';
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>