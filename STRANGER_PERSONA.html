<!DOCTYPE html>
<html lang="en">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-ML3F7KLZ');</script>
<script type="module" src="firebase-config.js"></script>
  <script type="module" src="game-engine.js"></script> <script src="components.js" defer></script>
<script type="module" src="assets/ux-core.js"></script> 

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">

  <title>Which Hawkins Role Are You? Stranger Things Persona Test | QuizRealm</title>
  <meta name="description" content="A premium Stranger Things persona test: 10 swipe questions to reveal your Hawkins archetype with a shareable result, deep-dive profile, and a quiz CTA.">
  <meta name="keywords" content="Stranger Things persona test, Hawkins role quiz, Vecna, Upside Down, Eleven, Stranger Things trivia, QuizRealm, personality test, shareable results">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Which Hawkins Role Are You? Stranger Things Persona Test">
  <meta property="og:description" content="10 swipe questions. Premium results. Shareable link. Deep-dive profile.">
  <meta property="og:image" content="https://thequizrealm.com/assets/stranger-persona.png">
  <meta property="og:url" content="https://thequizrealm.com/STRANGER_PERSONA.html">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="canonical" href="https://thequizrealm.com/STRANGER_PERSONA.html">

  <link rel="manifest" href="/assets/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">
  <meta name="msapplication-TileColor" content="#04020a">
  <meta name="theme-color" content="#04020a">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@300;400;500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            arcade: ['Bungee', 'cursive'],
            sans: ['Outfit', 'sans-serif'],
            mono: ['Share Tech Mono', 'monospace']
          },
          colors: {
            bgDarker: '#04020a',
            accentRed: '#ef4444',
            accentPurple: '#a855f7',
            accentCyan: '#06b6d4',
            accentBlue: '#3b82f6',
            accentGreen: '#22c55e',
            accentAsh: '#94a3b8',
            accentGold: '#fbbf24'
          }
        }
      }
    }
  </script>

  <style>
    body{
      background-color:#04020a;
      background-image:
        radial-gradient(circle at 50% 0%, rgba(239,68,68,0.22), rgba(4,2,10,0.92) 60%),
        radial-gradient(circle at 85% 35%, rgba(168,85,247,0.20), transparent 55%),
        radial-gradient(circle at 15% 55%, rgba(6,182,212,0.12), transparent 55%);
      color:#e2e8f0;
      min-height:100vh;
      overflow-x:hidden;
    }
    .grid-bg{
      background-size:60px 60px;
      background-image:
        linear-gradient(to right, rgba(168,85,247,0.035) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(239,68,68,0.03) 1px, transparent 1px);
      mask-image: linear-gradient(to bottom, black 22%, transparent 92%);
    }
    .glass{
      background: rgba(18,10,28,0.62);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 18px 60px -40px rgba(0,0,0,0.9);
    }

    .ratio-9-16{ position:relative; width:100%; padding-top:177.7778%; }
    .ratio-9-16 > img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    .ratio-16-9{ position:relative; width:100%; padding-top:56.25%; }
    .ratio-16-9 > img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }

    .pill-link{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(226,232,240,0.92);
      transition: background .15s ease, border-color .15s ease, transform .15s ease, color .15s ease;
      text-decoration:none; font-size:12px; font-weight:900; letter-spacing:.12em; text-transform:uppercase;
    }
    .pill-link:hover{
      background: rgba(255,255,255,0.07);
      border-color: rgba(239,68,68,0.55);
      transform: translateY(-1px);
      color:#fff;
    }

    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      font-size:10px; font-family:'Share Tech Mono', monospace;
      text-transform:uppercase; letter-spacing:.18em;
      color: rgba(226,232,240,0.80);
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      color: rgba(226,232,240,0.90);
      font-size:11px; font-weight:900; letter-spacing:.12em; text-transform:uppercase;
      white-space:nowrap;
    }

    .btn-primary{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:16px;
      font-weight:900; letter-spacing:.14em; text-transform:uppercase; font-size:12px;
      color:#fff;
      background: linear-gradient(90deg, #ef4444, #a855f7);
      border:1px solid rgba(255,255,255,0.14);
      transition: transform .18s ease, filter .18s ease;
      text-decoration:none;
    }
    .btn-primary:hover{ transform: translateY(-2px); filter: brightness(1.08); }

    .btn-ghost{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:16px;
      font-weight:900; letter-spacing:.14em; text-transform:uppercase; font-size:12px;
      color: rgba(226,232,240,0.92);
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.12);
      transition: transform .18s ease, background .18s ease, border-color .18s ease, color .18s ease;
      text-decoration:none;
    }
    .btn-ghost:hover{
      transform: translateY(-2px);
      background: rgba(255,255,255,0.07);
      border-color: rgba(168,85,247,0.45);
      color:#fff;
    }

    .soft-divider{
      height:1px; width:100%;
      background: linear-gradient(90deg, rgba(239,68,68,0.0), rgba(239,68,68,0.22), rgba(168,85,247,0.18), rgba(239,68,68,0.0));
    }

    .accent-title{ border-left:4px solid rgba(239,68,68,0.8); padding-left:12px; }

    .card-mini{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding:14px;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
    }
    .card-mini:hover{
      transform: translateY(-2px);
      border-color: rgba(168,85,247,0.45);
      background: rgba(0,0,0,0.24);
    }

    .swipe-stage{ position:relative; }
    .swipe-card{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10,6,18,0.62);
      backdrop-filter: blur(14px);
      box-shadow: 0 24px 80px -55px rgba(0,0,0,0.95);
      user-select:none;
      touch-action: pan-y;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .swipe-overlay{
      position:absolute; inset:0;
      pointer-events:none;
      display:flex; align-items:flex-start; justify-content:space-between;
      padding:18px;
      opacity:0;
      transition: opacity .12s ease;
    }
    .swipe-badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      font-weight:900; letter-spacing:.14em; text-transform:uppercase; font-size:11px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.30);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px -40px rgba(0,0,0,0.9);
    }
    .swipe-badge.left{ color:#22c55e; border-color: rgba(34,197,94,0.35); }
    .swipe-badge.right{ color:#ef4444; border-color: rgba(239,68,68,0.35); }

    .progress-track{
      height:10px; border-radius:999px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .progress-bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(239,68,68,0.9), rgba(168,85,247,0.85));
      border-right:1px solid rgba(255,255,255,0.18);
      transition: width .25s ease;
    }

    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:60;
    }
    .modal{
      width:100%;
      max-width:900px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(18,10,28,0.82);
      box-shadow: 0 24px 90px -60px rgba(0,0,0,0.98);
      overflow:hidden;
    }
  </style>

  <script type="application/ld+json">
    {
      "@context":"https://schema.org",
      "@type":"WebPage",
      "name":"Which Hawkins Role Are You? Stranger Things Persona Test",
      "url":"https://thequizrealm.com/STRANGER_PERSONA.html",
      "inLanguage":"en",
      "about":[{"@type":"TVSeries","name":"Stranger Things"}],
      "publisher":{"@type":"Organization","name":"QuizRealm"}
    }
  </script>
</head>

<body class="flex flex-col antialiased selection:bg-accentPurple selection:text-white">
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-ML3F7KLZ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <div class="fixed inset-0 grid-bg pointer-events-none z-[-1]"></div>

  <quiz-header></quiz-header>

  <main class="flex-grow w-full max-w-7xl mx-auto px-4 py-10 md:py-14 space-y-10">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex flex-wrap items-center gap-3">
        <a class="pill-link" href="/index.html"><i class="fas fa-house"></i> Home</a>
        <a class="pill-link" href="/categories.html"><i class="fas fa-layer-group"></i> Categories</a>
        <a class="pill-link" href="/mode.html?category=strangerthings"><i class="fas fa-play"></i> Play Stranger Things</a>
      </div>
      <div class="text-[10px] font-mono text-slate-400 uppercase tracking-widest">
        Persona Test • TV • Stranger Things • Shareable Results
      </div>
    </div>

    <section class="glass rounded-2xl p-6 md:p-8 overflow-hidden">
      <div class="flex flex-col lg:flex-row gap-8 lg:items-center">
        <div class="flex-1 space-y-4">
          <div class="kicker">
            <i class="fas fa-bolt text-accentRed"></i>
            Hawkins Role Index • 10 Swipe Questions • Instant Result
          </div>

          <h1 class="font-arcade text-3xl md:text-5xl text-white leading-tight">
            Which Hawkins Role Are You?
          </h1>

          <p class="text-slate-300 leading-relaxed max-w-2xl">
            In Hawkins, survival isn’t luck—it’s role clarity. This test reveals how you operate under pressure:
            the <span class="font-bold text-white">Strategist</span>, the <span class="font-bold text-white">Protector</span>,
            the <span class="font-bold text-white">Investigator</span>, or the <span class="font-bold text-white">Wildcard</span>.
            Swipe instinctively. Your result is shareable and saved to your QuizRealm profile.
          </p>

          <div class="flex flex-wrap gap-2 pt-1">
            <span class="chip"><i class="fas fa-hand-pointer text-accentCyan"></i> Tap or Swipe</span>
            <span class="chip"><i class="fas fa-shield-halved text-accentGreen"></i> Archetype Score</span>
            <span class="chip"><i class="fas fa-link text-accentPurple"></i> Share Link</span>
            <span class="chip"><i class="fas fa-database text-accentAsh"></i> Saved to Firebase</span>
          </div>

          <div id="screen-start" class="pt-2">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 max-w-2xl">
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-hourglass-half text-accentGold"></i> Time
                </div>
                <div class="mt-1 text-white font-bold text-lg">90 seconds</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed">Fast pacing, zero overthinking, maximum accuracy.</div>
              </div>
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-chart-simple text-accentCyan"></i> Output
                </div>
                <div class="mt-1 text-white font-bold text-lg">Score Bars</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed">A clean profile plus a deep-dive modal if you want it.</div>
              </div>
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-trophy text-accentPurple"></i> Reward
                </div>
                <div class="mt-1 text-white font-bold text-lg">Unlock CTA</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed">Instantly jump into Stranger Things quizzes after results.</div>
              </div>
            </div>

            <div class="flex flex-wrap gap-3 pt-5">
              <button id="btnStart" class="btn-primary">
                Start The Test <i class="fas fa-arrow-right"></i>
              </button>
              <a href="/mode.html?category=strangerthings" class="btn-ghost">
                Skip To Quiz <i class="fas fa-play"></i>
              </a>
            </div>

            <div class="text-xs text-slate-500 leading-relaxed mt-4 max-w-2xl">
              This page uses analytics events to improve quiz design and saves test outcomes to your QuizRealm profile when available.
            </div>
          </div>

          <div id="screen-quiz" class="hidden pt-2 space-y-4">
            <div class="flex items-center justify-between gap-3">
              <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400">
                Question <span id="qIndex">1</span> / <span id="qTotal">10</span>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnBack" class="btn-ghost px-4 py-2 rounded-xl text-[11px]">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button id="btnRestart" class="btn-ghost px-4 py-2 rounded-xl text-[11px]">
                  <i class="fas fa-rotate"></i> Restart
                </button>
              </div>
            </div>

            <div class="progress-track">
              <div id="progressBar" class="progress-bar"></div>
            </div>

            <div class="swipe-stage">
              <div id="swipeCard" class="swipe-card">
                <div id="swipeOverlay" class="swipe-overlay">
                  <div class="swipe-badge left"><i class="fas fa-check"></i> LEFT</div>
                  <div class="swipe-badge right"><i class="fas fa-bolt"></i> RIGHT</div>
                </div>

                <div class="p-6 md:p-7 space-y-4">
                  <div class="kicker">
                    <i class="fas fa-signal text-accentCyan"></i>
                    Choose instinctively
                  </div>

                  <div class="text-white font-arcade text-2xl md:text-3xl leading-tight" id="qTitle">...</div>
                  <div class="text-slate-300 leading-relaxed" id="qPrompt">...</div>

                  <div class="soft-divider"></div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button id="optLeft" class="card-mini text-left">
                      <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                        <i class="fas fa-left-long text-accentGreen"></i> Swipe Left
                      </div>
                      <div class="mt-2 text-white font-bold text-lg" id="optLeftTitle">...</div>
                      <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="optLeftDesc">...</div>
                    </button>

                    <button id="optRight" class="card-mini text-left">
                      <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                        <i class="fas fa-right-long text-accentRed"></i> Swipe Right
                      </div>
                      <div class="mt-2 text-white font-bold text-lg" id="optRightTitle">...</div>
                      <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="optRightDesc">...</div>
                    </button>
                  </div>

                  <div class="text-xs text-slate-500 leading-relaxed">
                    Tip: On mobile, drag the card left/right. On desktop, click an option.
                  </div>
                </div>
              </div>
            </div>

            <div id="saveStatus" class="text-xs text-slate-500 pt-1"></div>
          </div>

          <div id="screen-results" class="hidden pt-2 space-y-4">
            <div class="kicker">
              <i class="fas fa-award text-accentGold"></i>
              Your Hawkins Archetype
            </div>

            <div class="glass rounded-2xl p-6 md:p-7 border border-white/10">
              <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                <div class="space-y-3 flex-1">
                  <div id="resultBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/30 border border-white/10 text-[10px] font-mono uppercase tracking-widest text-slate-300">
                    <i class="fas fa-user-shield text-accentGreen"></i> Result
                  </div>

                  <h2 id="resultTitle" class="font-arcade text-3xl md:text-4xl text-white leading-tight">...</h2>
                  <p id="resultShort" class="text-slate-300 leading-relaxed max-w-2xl">...</p>

                  <div class="flex flex-wrap gap-3 pt-1">
                    <button id="btnShare" class="btn-primary">
                      Share Result <i class="fas fa-link"></i>
                    </button>
                    <button id="btnCopy" class="btn-ghost">
                      Copy Link <i class="fas fa-copy"></i>
                    </button>
                    <button id="btnDeepDive" class="btn-ghost">
                      Deep Dive <i class="fas fa-book-open"></i>
                    </button>
                  </div>

                  <div id="shareHint" class="text-xs text-slate-500"></div>
                </div>

                <div class="w-full md:w-[340px] space-y-3">
                  <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400">Archetype Score Bars</div>

                  <div class="space-y-3" id="scoreBars"></div>

                  <div class="soft-divider"></div>

                  <a href="/mode.html?category=strangerthings" class="btn-primary w-full">
                    Play Stranger Things Quiz <i class="fas fa-play"></i>
                  </a>
                  <button id="btnRetake" class="btn-ghost w-full">
                    Retake Test <i class="fas fa-rotate"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-database text-accentAsh"></i> Saved
                </div>
                <div class="mt-1 text-white font-bold text-lg" id="savedLabel">Saving…</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="savedMeta">Your result is being stored for profile insights.</div>
              </div>
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-share-nodes text-accentPurple"></i> Shareable
                </div>
                <div class="mt-1 text-white font-bold text-lg">One Link</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed">Your link opens a clean public result view.</div>
              </div>
              <div class="card-mini">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
                  <i class="fas fa-bolt text-accentRed"></i> Next Move
                </div>
                <div class="mt-1 text-white font-bold text-lg">Hard Mode</div>
                <div class="mt-1 text-sm text-slate-400 leading-relaxed">Try Stranger Things quizzes after you see your archetype.</div>
              </div>
            </div>
          </div>

          <div id="screen-shared" class="hidden pt-2 space-y-4">
            <div class="kicker">
              <i class="fas fa-link text-accentPurple"></i>
              Shared Result View
            </div>

            <div class="glass rounded-2xl p-6 md:p-7 border border-white/10">
              <h2 class="font-arcade text-3xl text-white" id="sharedTitle">...</h2>
              <p class="text-slate-300 leading-relaxed mt-2" id="sharedShort">...</p>

              <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
                <a href="/STRANGER_PERSONA.html" class="btn-primary w-full">
                  Take The Test <i class="fas fa-arrow-right"></i>
                </a>
                <a href="/mode.html?category=strangerthings" class="btn-ghost w-full">
                  Play Stranger Things Quiz <i class="fas fa-play"></i>
                </a>
              </div>

              <div class="mt-5">
                <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400">Score Bars</div>
                <div class="mt-3 space-y-3" id="sharedBars"></div>
              </div>
            </div>
          </div>

        </div>

        <div class="w-full lg:w-[360px] lg:flex-shrink-0 space-y-4">
          

          <div class="rounded-2xl overflow-hidden border border-white/10 shadow-[0_0_60px_rgba(239,68,68,0.12)]">
            <div class="ratio-9-16">
              <img src="/assets/strangerthings-poster.png" alt="Stranger Things Poster">
            </div>
          </div>

        

         
        </div>
      </div>
    </section>
  </main>

  <div id="deepDiveBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="p-5 md:p-6 border-b border-white/10 flex items-center justify-between gap-3">
        <div>
          <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400">Deep Dive Profile</div>
          <div class="text-white font-bold text-lg" id="deepDiveHeader">...</div>
        </div>
        <button id="btnCloseDeepDive" class="btn-ghost px-4 py-2 rounded-xl text-[11px]">
          Close <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div class="p-5 md:p-6 space-y-4">
        <div class="glass rounded-2xl p-5 border border-white/10">
          <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400">Long Description</div>
          <div class="mt-2 text-slate-200 leading-relaxed" id="deepDiveBody">...</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="card-mini">
            <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <i class="fas fa-crosshairs text-accentRed"></i> Strength
            </div>
            <div class="mt-2 text-white font-bold" id="deepDiveStrength">...</div>
            <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="deepDiveStrengthDesc">...</div>
          </div>
          <div class="card-mini">
            <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <i class="fas fa-triangle-exclamation text-accentGold"></i> Risk
            </div>
            <div class="mt-2 text-white font-bold" id="deepDiveRisk">...</div>
            <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="deepDiveRiskDesc">...</div>
          </div>
          <div class="card-mini">
            <div class="text-[10px] font-mono uppercase tracking-widest text-slate-400 flex items-center gap-2">
              <i class="fas fa-play text-accentCyan"></i> Best Next Step
            </div>
            <div class="mt-2 text-white font-bold" id="deepDiveNext">...</div>
            <div class="mt-1 text-sm text-slate-400 leading-relaxed" id="deepDiveNextDesc">...</div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          <a href="/mode.html?category=strangerthings" class="btn-primary">
            Jump Into Stranger Things Quiz <i class="fas fa-play"></i>
          </a>
          <button id="btnCopyFromModal" class="btn-ghost">
            Copy Share Link <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <quiz-footer></quiz-footer>

  <script type="module">
    const CATEGORY = "strangerthings";
    const TEST_KEY = "STRANGER_PERSONA_V1";
    const COLLECTION = "persona_results";

    const $ = (id) => document.getElementById(id);

    const screenStart = $("screen-start");
    const screenQuiz = $("screen-quiz");
    const screenResults = $("screen-results");
    const screenShared = $("screen-shared");

    const btnStart = $("btnStart");
    const btnBack = $("btnBack");
    const btnRestart = $("btnRestart");

    const qIndexEl = $("qIndex");
    const qTotalEl = $("qTotal");
    const progressBar = $("progressBar");

    const swipeCard = $("swipeCard");
    const swipeOverlay = $("swipeOverlay");
    const optLeft = $("optLeft");
    const optRight = $("optRight");

    const qTitle = $("qTitle");
    const qPrompt = $("qPrompt");
    const optLeftTitle = $("optLeftTitle");
    const optLeftDesc = $("optLeftDesc");
    const optRightTitle = $("optRightTitle");
    const optRightDesc = $("optRightDesc");

    const saveStatus = $("saveStatus");

    const resultBadge = $("resultBadge");
    const resultTitle = $("resultTitle");
    const resultShort = $("resultShort");
    const scoreBars = $("scoreBars");
    const btnShare = $("btnShare");
    const btnCopy = $("btnCopy");
    const btnDeepDive = $("btnDeepDive");
    const btnRetake = $("btnRetake");
    const shareHint = $("shareHint");
    const savedLabel = $("savedLabel");
    const savedMeta = $("savedMeta");

    const deepDiveBackdrop = $("deepDiveBackdrop");
    const btnCloseDeepDive = $("btnCloseDeepDive");
    const deepDiveHeader = $("deepDiveHeader");
    const deepDiveBody = $("deepDiveBody");
    const deepDiveStrength = $("deepDiveStrength");
    const deepDiveStrengthDesc = $("deepDiveStrengthDesc");
    const deepDiveRisk = $("deepDiveRisk");
    const deepDiveRiskDesc = $("deepDiveRiskDesc");
    const deepDiveNext = $("deepDiveNext");
    const deepDiveNextDesc = $("deepDiveNextDesc");
    const btnCopyFromModal = $("btnCopyFromModal");

    const sharedTitle = $("sharedTitle");
    const sharedShort = $("sharedShort");
    const sharedBars = $("sharedBars");

    const Archetypes = {
      strategist: {
        name: "The Strategist",
        icon: "fa-chess",
        tint: "from-blue-600 to-purple-600",
        short: "You map chaos into a plan. You move pieces, manage risk, and keep the team two steps ahead.",
        long: "In Hawkins, panic kills. You’re the person who turns rumors into signals and signals into action. You think in routes, contingency plans, and “what breaks next.” You don’t need to be the loudest—you need to be right. Your best moments show up when the group is overwhelmed and someone must decide quickly, calmly, and correctly. People trust you with the hard calls, even when they don’t say it out loud.",
        strength: ["Operational clarity", "You create momentum with structure and smart sequencing."],
        risk: ["Over-control", "You can dismiss instincts and human emotion as “noise.”"],
        next: ["Lead the strategy layer", "Try hard-mode trivia: micro-details and timeline questions."]
      },
      protector: {
        name: "The Protector",
        icon: "fa-shield-halved",
        tint: "from-emerald-600 to-cyan-600",
        short: "You stabilize the room. You move first to protect others and absorb pressure without collapsing.",
        long: "Hawkins needs a shield. You are the one who steps between danger and the people you care about. You don’t need perfect information to act—you need a clear priority: keep the team safe and together. Your power is emotional steadiness under stress. When the group starts to fracture, you become the glue. You don’t win by being reckless; you win by refusing to abandon anyone.",
        strength: ["Team cohesion", "You prevent spirals: fear, blame, and isolation."],
        risk: ["Self-neglect", "You take on too much and can burn out quietly."],
        next: ["Anchor the team", "Play modes that reward clutch decisions and risk management."]
      },
      investigator: {
        name: "The Investigator",
        icon: "fa-magnifying-glass",
        tint: "from-purple-600 to-red-600",
        short: "You find the hidden pattern. You pull truth out of noise, details, and contradictions.",
        long: "You’re allergic to unanswered questions. When something feels “off,” you don’t ignore it—you trace it. You collect clues, compare stories, and reconstruct what really happened. In Hawkins, where half the town pretends nothing is wrong, your ability to see the seams is survival. You don’t need to be fearless; you need to be curious enough to keep going until the world makes sense again.",
        strength: ["Signal extraction", "You turn scattered details into a coherent story."],
        risk: ["Tunnel vision", "You can chase truth past the point of safety."],
        next: ["Own the clue work", "Try visual trivia, object details, and lore questions."]
      },
      wildcard: {
        name: "The Wildcard",
        icon: "fa-bolt",
        tint: "from-red-600 to-purple-600",
        short: "You break the script. You improvise, disrupt the enemy’s rhythm, and pull wins out of impossible moments.",
        long: "Hawkins isn’t fair—so you don’t play fair. You adapt faster than the situation changes. Your best move is often the one nobody else sees coming. You bring energy, creativity, and surprising bravery, especially when morale is low. You’re not chaos for chaos’ sake—you’re the spark that forces a new path when the old one fails.",
        strength: ["Adaptive courage", "You turn surprise into advantage."],
        risk: ["Inconsistency", "Your best ideas can arrive without a safety net."],
        next: ["Be the spark", "Play modes that reward speed, instinct, and scene recognition."]
      }
    };

    const Questions = [
      {
        id: "q1",
        title: "Your walkie crackles with static.",
        prompt: "You’re out at night. The signal spikes, lights flicker, and everyone freezes. What do you do first?",
        left: { title: "Lock the team together", desc: "Pull everyone in, reduce noise, and move as one.", points: { protector: 3, strategist: 1 } },
        right:{ title: "Probe the signal", desc: "Track direction, timing, and what triggers the interference.", points: { investigator: 3, strategist: 1 } }
      },
      {
        id: "q2",
        title: "You find a sealed door with fresh scratches.",
        prompt: "It’s not on the map. Something has been trying to get out. What’s your instinct?",
        left: { title: "Create a controlled plan", desc: "Mark exits, set roles, and approach with structure.", points: { strategist: 3, protector: 1 } },
        right:{ title: "Open it fast (with a trick)", desc: "Improvise: mirror, bait, distraction—anything that works.", points: { wildcard: 3, investigator: 1 } }
      },
      {
        id: "q3",
        title: "A friend says: “I feel… watched.”",
        prompt: "They’re not being dramatic. Their voice is different. What do you prioritize?",
        left: { title: "Ground them emotionally", desc: "Calm breathing, real talk, keep them present.", points: { protector: 3, investigator: 1 } },
        right:{ title: "Test the pattern", desc: "Ask precise questions to confirm what’s happening.", points: { investigator: 3, strategist: 1 } }
      },
      {
        id: "q4",
        title: "You get one minute to brief the team.",
        prompt: "There’s a gate risk tonight. Everyone’s scared. What kind of briefing do you give?",
        left: { title: "Clear roles + sequence", desc: "Who does what, in what order, if things go wrong.", points: { strategist: 3, protector: 1 } },
        right:{ title: "A hype ignition", desc: "Confidence boost: energy, humor, and rapid action.", points: { wildcard: 3, protector: 1 } }
      },
      {
        id: "q5",
        title: "You spot a clue everyone missed.",
        prompt: "A small detail changes the whole story. What’s your next move?",
        left: { title: "Verify twice", desc: "Cross-check quickly before you pivot the plan.", points: { investigator: 2, strategist: 2 } },
        right:{ title: "Pivot immediately", desc: "Move now and let evidence catch up behind you.", points: { wildcard: 2, strategist: 2 } }
      },
      {
        id: "q6",
        title: "Someone proposes a risky rescue.",
        prompt: "High reward, high danger. If it fails, it’s catastrophic. How do you respond?",
        left: { title: "Reduce risk first", desc: "Safety net, backup route, and a second attempt plan.", points: { strategist: 2, protector: 2 } },
        right:{ title: "Take the window", desc: "The opportunity is now. Delay is the real danger.", points: { wildcard: 2, protector: 2 } }
      },
      {
        id: "q7",
        title: "The enemy learns your routine.",
        prompt: "What do you do when your predictable habits become a vulnerability?",
        left: { title: "Change the pattern", desc: "Rotate routes, timings, and roles. No repeat behavior.", points: { strategist: 2, investigator: 2 } },
        right:{ title: "Create controlled chaos", desc: "Decoy moves, unexpected choices, and bait traps.", points: { wildcard: 2, strategist: 2 } }
      },
      {
        id: "q8",
        title: "The group starts blaming each other.",
        prompt: "Stress turns into conflict. What’s your leadership instinct?",
        left: { title: "Stabilize the room", desc: "Lower voices, rebuild trust, stop the fracture.", points: { protector: 3, strategist: 1 } },
        right:{ title: "Refocus with facts", desc: "Evidence, timeline, priorities. Bring it back to reality.", points: { investigator: 2, strategist: 2 } }
      },
      {
        id: "q9",
        title: "A gate opens in the worst place possible.",
        prompt: "You have seconds. The environment is changing. What do you choose?",
        left: { title: "Evac + protect", desc: "Get people out. Minimize casualties. Keep the core safe.", points: { protector: 3, strategist: 1 } },
        right:{ title: "Disrupt the threat", desc: "Do the bold move that breaks momentum and buys time.", points: { wildcard: 3, investigator: 1 } }
      },
      {
        id: "q10",
        title: "Final confrontation: you get one advantage.",
        prompt: "You can take one advantage into the fight. Which feels most like you?",
        left: { title: "A perfect plan", desc: "Roles, timing, and contingencies that close the trap.", points: { strategist: 3, investigator: 1 } },
        right:{ title: "A perfect instinct", desc: "Fast adaptation and fearless improvisation under pressure.", points: { wildcard: 2, protector: 1, investigator: 1 } }
      }
    ];

    const storage = {
      get(k){ try{ return JSON.parse(localStorage.getItem(k) || "null"); }catch(_){ return null; } },
      set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } },
      del(k){ try{ localStorage.removeItem(k); }catch(_){ } }
    };

    function sid(){
      const existing = storage.get("qr_sid");
      if(existing && typeof existing === "string") return existing;
      const v = "sid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
      storage.set("qr_sid", v);
      return v;
    }

    function dlPush(event, payload = {}){
      try{
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ event, ...payload });
      }catch(_){}
    }

    function engineTrack(name, payload = {}){
      const safe = (fn) => { try{ fn(); }catch(_){ } };
      safe(()=> dlPush(name, { category: CATEGORY, test: TEST_KEY, ...payload }));

      if(window.gameEngine && typeof window.gameEngine.trackEvent === "function"){
        safe(()=> window.gameEngine.trackEvent(name, payload));
      }
      if(window.QR && typeof window.QR.trackEvent === "function"){
        safe(()=> window.QR.trackEvent(name, payload));
      }
      if(typeof window.trackEvent === "function"){
        safe(()=> window.trackEvent(name, payload));
      }
    }

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function scoreInit(){
      return { strategist: 0, protector: 0, investigator: 0, wildcard: 0 };
    }
    function applyPoints(score, pts){
      const out = { ...score };
      for(const k of Object.keys(pts)){
        out[k] = (out[k] || 0) + (pts[k] || 0);
      }
      return out;
    }
    function sumScore(score){
      return Object.values(score).reduce((a,b)=>a+b,0);
    }
    function winner(score){
      const entries = Object.entries(score).sort((a,b)=>b[1]-a[1]);
      return entries[0]?.[0] || "strategist";
    }

    function pct(score, key){
      const total = Math.max(1, sumScore(score));
      return Math.round((score[key] || 0) / total * 100);
    }

    function archetypeLabel(key){
      const a = Archetypes[key];
      return a ? a.name : "Result";
    }

    function barRow(key, valuePct){
      const a = Archetypes[key];
      const icon = a?.icon || "fa-star";
      const name = a?.name || key;
      const val = clamp(valuePct, 0, 100);

      const row = document.createElement("div");
      row.className = "rounded-2xl border border-white/10 bg-black/20 p-4";

      row.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <i class="fas ${icon} text-accentPurple"></i>
            <div class="text-white font-bold">${name}</div>
          </div>
          <div class="text-xs font-mono uppercase tracking-widest text-slate-400">${val}%</div>
        </div>
        <div class="mt-3 progress-track">
          <div class="progress-bar" style="width:${val}%"></div>
        </div>
      `;
      return row;
    }

    function setBadgeFor(key){
      const a = Archetypes[key];
      const icon = a?.icon || "fa-award";
      const map = {
        strategist: "text-accentBlue",
        protector: "text-accentGreen",
        investigator: "text-accentPurple",
        wildcard: "text-accentRed"
      };
      const color = map[key] || "text-slate-300";
      resultBadge.innerHTML = `<i class="fas ${icon} ${color}"></i> ${archetypeLabel(key)}`;
    }

    function b64UrlEncode(obj){
      const json = JSON.stringify(obj);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }
    function b64UrlDecode(str){
      const pad = str.length % 4 === 0 ? "" : "=".repeat(4 - (str.length % 4));
      const b64 = (str.replaceAll("-","+").replaceAll("_","/")) + pad;
      const json = decodeURIComponent(escape(atob(b64)));
      return JSON.parse(json);
    }

    const state = {
      sid: sid(),
      idx: 0,
      answers: [],
      score: scoreInit(),
      resultKey: null,
      shareUrl: null,
      rid: null,
      firebase: { ready:false, db:null, auth:null, fs:null, authMod:null }
    };

    async function initFirebaseIfPossible(){
      try{
        const appMod = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
        const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
        const authMod = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");

        if(appMod.getApps().length === 0){
          return;
        }
        const app = appMod.getApp();
        const db = fsMod.getFirestore(app);
        const auth = authMod.getAuth(app);

        state.firebase = { ready:true, db, auth, fs:fsMod, authMod };
      }catch(_){
      }
    }

    function buildShareUrl(payload){
      const base = location.origin + location.pathname;
      const encoded = b64UrlEncode(payload);
      const u = new URL(base);
      if(state.rid) u.searchParams.set("rid", state.rid);
      u.searchParams.set("r", encoded);
      u.searchParams.set("utm_source", "share");
      u.searchParams.set("utm_medium", "persona");
      u.searchParams.set("utm_campaign", CATEGORY);
      return u.toString();
    }

    async function saveToFirestore(finalPayload){
      const fb = state.firebase;
      if(!fb.ready || !fb.db || !fb.fs) return { id: null, method: "none" };

      const id = "st_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
      const uid = fb.auth?.currentUser?.uid || null;

      const docRef = fb.fs.doc(fb.db, COLLECTION, id);
      const payload = {
        ...finalPayload,
        rid: id,
        uid,
        isAnon: !uid,
        createdAt: fb.fs.serverTimestamp(),
        updatedAt: fb.fs.serverTimestamp()
      };

      await fb.fs.setDoc(docRef, payload, { merge: true });
      return { id, method: "firestore" };
    }

    async function readFromFirestore(rid){
      const fb = state.firebase;
      if(!fb.ready || !fb.db || !fb.fs) return null;
      try{
        const ref = fb.fs.doc(fb.db, COLLECTION, rid);
        const snap = await fb.fs.getDoc(ref);
        if(!snap.exists()) return null;
        return snap.data();
      }catch(_){
        return null;
      }
    }

    function saveLocal(finalPayload){
      const id = "st_local_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,8);
      storage.set("persona_" + id, finalPayload);
      return { id, method: "local" };
    }

    function setProgress(){
      qIndexEl.textContent = String(state.idx + 1);
      qTotalEl.textContent = String(Questions.length);
      const pct = Math.round(((state.idx) / Questions.length) * 100);
      progressBar.style.width = pct + "%";
    }

    function renderQuestion(){
      const q = Questions[state.idx];
      if(!q) return;

      setProgress();
      swipeCard.style.transform = "translate3d(0,0,0) rotate(0deg)";
      swipeOverlay.style.opacity = "0";

      qTitle.textContent = q.title;
      qPrompt.textContent = q.prompt;

      optLeftTitle.textContent = q.left.title;
      optLeftDesc.textContent = q.left.desc;

      optRightTitle.textContent = q.right.title;
      optRightDesc.textContent = q.right.desc;

      btnBack.disabled = state.idx === 0;
      btnBack.style.opacity = state.idx === 0 ? "0.5" : "1";
    }

    function startTest(){
      state.idx = 0;
      state.answers = [];
      state.score = scoreInit();
      state.resultKey = null;
      state.shareUrl = null;
      state.rid = null;

      hide(screenStart);
      hide(screenResults);
      hide(screenShared);
      show(screenQuiz);

      saveStatus.textContent = "";
      engineTrack("persona_start", { sid: state.sid, testKey: TEST_KEY });

      renderQuestion();
    }

    function restartTest(){
      engineTrack("persona_restart", { sid: state.sid, testKey: TEST_KEY });
      show(screenStart);
      hide(screenQuiz);
      hide(screenResults);
      hide(screenShared);
      state.idx = 0;
      state.answers = [];
      state.score = scoreInit();
      state.resultKey = null;
      state.shareUrl = null;
      state.rid = null;
      progressBar.style.width = "0%";
    }

    function recordAnswer(direction){
      const q = Questions[state.idx];
      if(!q) return;

      const choice = direction === "left" ? q.left : q.right;
      state.score = applyPoints(state.score, choice.points);

      const answer = {
        qid: q.id,
        direction,
        choiceTitle: choice.title,
        points: choice.points,
        t: Date.now()
      };
      state.answers.push(answer);

      engineTrack("persona_answer", {
        sid: state.sid,
        testKey: TEST_KEY,
        qid: q.id,
        direction,
        choice: choice.title
      });

      state.idx += 1;
      if(state.idx >= Questions.length){
        finishTest();
      }else{
        renderQuestion();
      }
    }

    function makeScoreBars(container, score){
      container.innerHTML = "";
      const keys = ["strategist","protector","investigator","wildcard"];
      const ordered = keys
        .map(k => [k, pct(score, k)])
        .sort((a,b)=>b[1]-a[1]);

      for(const [k, p] of ordered){
        container.appendChild(barRow(k, p));
      }
    }

    function resultPayload(){
      const rk = state.resultKey || winner(state.score);
      const a = Archetypes[rk];

      return {
        category: CATEGORY,
        testKey: TEST_KEY,
        sid: state.sid,
        resultKey: rk,
        resultName: a?.name || rk,
        score: state.score,
        scorePct: {
          strategist: pct(state.score, "strategist"),
          protector: pct(state.score, "protector"),
          investigator: pct(state.score, "investigator"),
          wildcard: pct(state.score, "wildcard")
        }
      };
    }

    async function finishTest(){
      state.resultKey = winner(state.score);
      const a = Archetypes[state.resultKey];

      hide(screenQuiz);
      hide(screenStart);
      hide(screenShared);
      show(screenResults);

      setBadgeFor(state.resultKey);
      resultTitle.textContent = a.name;
      resultShort.textContent = a.short;

      makeScoreBars(scoreBars, state.score);

      savedLabel.textContent = "Saving…";
      savedMeta.textContent = "Your result is being stored for profile insights.";
      shareHint.textContent = "";

      const payload = {
        ...resultPayload(),
        answers: state.answers,
        page: {
          path: location.pathname,
          href: location.href,
          referrer: document.referrer || null
        },
        client: {
          ua: navigator.userAgent,
          lang: navigator.language || null,
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || null
        },
        completedAt: Date.now()
      };

      engineTrack("persona_complete", {
        sid: state.sid,
        testKey: TEST_KEY,
        resultKey: state.resultKey
      });

      let saveRes = { id:null, method:"none" };

      try{
        await initFirebaseIfPossible();
        if(state.firebase.ready){
          saveRes = await saveToFirestore(payload);
        }
      }catch(_){}

      if(!saveRes.id){
        saveRes = saveLocal(payload);
      }

      state.rid = saveRes.id;
      state.shareUrl = buildShareUrl({
        resultKey: payload.resultKey,
        scorePct: payload.scorePct,
        resultName: payload.resultName
      });

      if(saveRes.method === "firestore"){
        savedLabel.textContent = "Saved to Firebase";
        savedMeta.textContent = "Your profile can use this result for personalization and future recommendations.";
      }else{
        savedLabel.textContent = "Saved locally";
        savedMeta.textContent = "Firebase wasn’t available. Result stored on this device as a fallback.";
      }

      shareHint.textContent = "Your share link is ready.";
      saveStatus.textContent = "";
    }

    function openDeepDive(){
      const rk = state.resultKey || "strategist";
      const a = Archetypes[rk];

      deepDiveHeader.textContent = a.name;
      deepDiveBody.textContent = a.long;

      deepDiveStrength.textContent = a.strength[0];
      deepDiveStrengthDesc.textContent = a.strength[1];

      deepDiveRisk.textContent = a.risk[0];
      deepDiveRiskDesc.textContent = a.risk[1];

      deepDiveNext.textContent = a.next[0];
      deepDiveNextDesc.textContent = a.next[1];

      deepDiveBackdrop.style.display = "flex";
      engineTrack("persona_deepdive_open", { sid: state.sid, testKey: TEST_KEY, resultKey: rk });
    }

    function closeDeepDive(){
      deepDiveBackdrop.style.display = "none";
      engineTrack("persona_deepdive_close", { sid: state.sid, testKey: TEST_KEY, resultKey: state.resultKey });
    }

    async function copyShare(){
      const url = state.shareUrl || location.href;
      try{
        await navigator.clipboard.writeText(url);
        shareHint.textContent = "Copied.";
      }catch(_){
        shareHint.textContent = "Copy failed. Your browser blocked clipboard access.";
      }
      engineTrack("persona_share_copy", { sid: state.sid, testKey: TEST_KEY, resultKey: state.resultKey });
    }

    async function nativeShare(){
      const url = state.shareUrl || location.href;
      const title = "My Hawkins Role Result";
      const text = "I just took the Hawkins Role Persona Test on QuizRealm. Here’s my result:";
      try{
        if(navigator.share){
          await navigator.share({ title, text, url });
          shareHint.textContent = "Shared.";
        }else{
          await copyShare();
        }
      }catch(_){
        await copyShare();
      }
      engineTrack("persona_share_native", { sid: state.sid, testKey: TEST_KEY, resultKey: state.resultKey });
    }

    function parseParams(){
      const u = new URL(location.href);
      return {
        rid: u.searchParams.get("rid"),
        r: u.searchParams.get("r")
      };
    }

    function renderSharedView(payload){
      hide(screenStart);
      hide(screenQuiz);
      hide(screenResults);
      show(screenShared);

      const rk = payload?.resultKey || "strategist";
      const a = Archetypes[rk] || Archetypes.strategist;

      sharedTitle.textContent = payload?.resultName || a.name;
      sharedShort.textContent = a.short;

      const scoreObj = payload?.scorePct || {
        strategist: 25, protector: 25, investigator: 25, wildcard: 25
      };

      sharedBars.innerHTML = "";
      const ordered = Object.entries(scoreObj).sort((x,y)=> (y[1]||0)-(x[1]||0));
      for(const [k,p] of ordered){
        sharedBars.appendChild(barRow(k, clamp(Number(p)||0, 0, 100)));
      }

      engineTrack("persona_shared_view", { testKey: TEST_KEY, resultKey: rk });
    }

    btnStart.addEventListener("click", startTest);
    btnRestart.addEventListener("click", restartTest);
    btnBack.addEventListener("click", () => {
      if(state.idx === 0) return;
      state.idx -= 1;
      const removed = state.answers.pop();
      if(removed && removed.points){
        const rollback = scoreInit();
        for(const a of state.answers){
          Object.assign(rollback, applyPoints(rollback, a.points));
        }
        state.score = rollback;
      }
      renderQuestion();
      engineTrack("persona_back", { sid: state.sid, testKey: TEST_KEY, idx: state.idx });
    });

    optLeft.addEventListener("click", () => recordAnswer("left"));
    optRight.addEventListener("click", () => recordAnswer("right"));

    btnShare.addEventListener("click", nativeShare);
    btnCopy.addEventListener("click", copyShare);
    btnDeepDive.addEventListener("click", openDeepDive);
    btnRetake.addEventListener("click", restartTest);

    btnCloseDeepDive.addEventListener("click", closeDeepDive);
    deepDiveBackdrop.addEventListener("click", (e) => {
      if(e.target === deepDiveBackdrop) closeDeepDive();
    });
    btnCopyFromModal.addEventListener("click", copyShare);

    let drag = { active:false, startX:0, startY:0, dx:0, dy:0 };
    const SWIPE_THRESH = 110;

    swipeCard.addEventListener("pointerdown", (e) => {
      drag.active = true;
      drag.startX = e.clientX;
      drag.startY = e.clientY;
      drag.dx = 0;
      drag.dy = 0;
      swipeCard.setPointerCapture(e.pointerId);
    });

    swipeCard.addEventListener("pointermove", (e) => {
      if(!drag.active) return;
      drag.dx = e.clientX - drag.startX;
      drag.dy = e.clientY - drag.startY;

      const x = drag.dx;
      const rot = clamp(x / 18, -10, 10);
      swipeCard.style.transform = `translate3d(${x}px, ${clamp(drag.dy/6, -18, 18)}px, 0) rotate(${rot}deg)`;

      const intensity = clamp(Math.abs(x) / 160, 0, 1);
      swipeOverlay.style.opacity = String(intensity);

      const left = swipeOverlay.querySelector(".left");
      const right = swipeOverlay.querySelector(".right");
      if(left && right){
        left.style.opacity = x < 0 ? "1" : "0.35";
        right.style.opacity = x > 0 ? "1" : "0.35";
      }
    });

    swipeCard.addEventListener("pointerup", () => {
      if(!drag.active) return;
      drag.active = false;

      const x = drag.dx;
      swipeOverlay.style.opacity = "0";

      if(x <= -SWIPE_THRESH){
        swipeCard.style.transform = `translate3d(-620px, 0, 0) rotate(-14deg)`;
        setTimeout(() => recordAnswer("left"), 120);
        return;
      }
      if(x >= SWIPE_THRESH){
        swipeCard.style.transform = `translate3d(620px, 0, 0) rotate(14deg)`;
        setTimeout(() => recordAnswer("right"), 120);
        return;
      }

      swipeCard.style.transform = "translate3d(0,0,0) rotate(0deg)";
    });

    window.addEventListener("keydown", (e) => {
      if(screenQuiz.classList.contains("hidden")) return;
      if(e.key === "ArrowLeft") recordAnswer("left");
      if(e.key === "ArrowRight") recordAnswer("right");
    });

    (async function boot(){
      qTotalEl.textContent = String(Questions.length);
      progressBar.style.width = "0%";

      const params = parseParams();
      if(params.rid || params.r){
        await initFirebaseIfPossible();

        let payload = null;
        if(params.rid){
          payload = await readFromFirestore(params.rid);
        }
        if(!payload && params.r){
          try{
            payload = b64UrlDecode(params.r);
          }catch(_){}
        }

        if(payload){
          renderSharedView(payload);
          return;
        }
      }

      engineTrack("persona_view", { testKey: TEST_KEY, category: CATEGORY, sid: state.sid });
      show(screenStart);
      hide(screenQuiz);
      hide(screenResults);
      hide(screenShared);
    })();
  </script>
</body>
</html>
