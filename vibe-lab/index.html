<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Security & SEO -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">
  <title>The Vibe Check‚Ñ¢ ‚Äî Ultimate Roast</title>
  <meta name="description" content="22 Questions. 1 Brutal Roast. Are you the Main Character or an NPC?" />
  <link rel="canonical" href="https://thequizrealm.com/" />
  
  <!-- Theme & Icons -->
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/favicon-192.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <meta name="msapplication-TileColor" content="#020617">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-ML3F7KLZ');</script>
  <!-- End Google Tag Manager -->

  <!-- YOUR PLATFORM SCRIPTS -->
  <script type="module" src="firebase-config.js"></script>
  <script src="game-engine.js"></script> 
  <script src="components.js" defer></script>
  <script src="data.js"></script>
  <script src="facts.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Oswald:wght@500;700&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#FF3B30', // Default Red
            toxic: '#CCFF00', // Acid Green
            dark: '#050505',
            spotify: '#1DB954',
            youtube: '#FF0000',
            gold: '#FFD700',
            platinum: '#E5E4E2'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            display: ['Oswald', 'sans-serif'],
            premium: ['Space Grotesk', 'sans-serif'],
          },
          animation: {
            'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
            'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
            'glitch': 'glitch 0.2s linear infinite',
            'breathe': 'breathe 4s ease-in-out infinite',
            'shine': 'shine 3s linear infinite',
          },
          keyframes: {
            pop: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
            shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
            glitch: { '0%': { transform: 'translate(0)' }, '20%': { transform: 'translate(-2px, 2px)' }, '40%': { transform: 'translate(-2px, -2px)' }, '60%': { transform: 'translate(2px, 2px)' }, '80%': { transform: 'translate(2px, -2px)' }, '100%': { transform: 'translate(0)' } },
            breathe: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' } },
            shine: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #000; color: white; overflow-x: hidden; transition: background-color 0.5s ease; }
    
    /* Backgrounds */
    .mode-normal .bg-dynamic { background: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #000000 80%); }
    .mode-adrenaline { background-color: #000; }
    .mode-adrenaline .bg-dynamic { background: repeating-linear-gradient(45deg, #111, #111 10px, #000 10px, #000 20px); }
    
    /* Utility */
    .tap-fast { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    select, input { background: #111; border: 1px solid #333; color: white; padding: 14px; border-radius: 8px; width: 100%; font-family: 'Inter'; outline: none; transition: border-color 0.3s; }
    select:focus, input:focus { border-color: #FF3B30; }
    
    /* PREMIUM BUTTON STYLE */
    .btn-premium {
      background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn-premium:hover {
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.7);
    }
    .btn-premium:active { transform: translateY(1px); }
    
    .btn-gold {
      background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
      color: black;
      border: none;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    .btn-gold:hover {
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
      transform: scale(1.02);
    }

    /* GLASS CARD */
    .card-glass {
      background: rgba(15, 15, 15, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
    }

    /* Blur for Locked Content */
    .blur-content { filter: blur(5px); opacity: 0.6; pointer-events: none; user-select: none; }
  </style>
</head>

<body class="mode-normal font-sans antialiased h-screen flex flex-col">

  <!-- HEADER -->
  <header class="fixed top-0 w-full z-50 px-6 py-5 flex justify-between items-center bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
    <div class="pointer-events-auto font-display font-bold text-xl tracking-wide uppercase flex items-center gap-2">
      <span class="bg-white text-black px-1">VC</span> The Vibe Check‚Ñ¢
    </div>
    <div id="mode-badge" class="pointer-events-auto bg-white/10 px-3 py-1 rounded-full backdrop-blur-md transition-colors duration-300">
      <span class="text-[10px] font-bold uppercase tracking-widest text-white/80">Culture Roast</span>
    </div>
  </header>

  <!-- MAIN APP -->
  <main class="flex-grow relative w-full h-full bg-dynamic transition-all duration-1000">

    <!-- SCREEN 1: LANDING -->
    <section id="screen-landing" class="absolute inset-0 flex flex-col items-center justify-center p-6">
      <div class="relative z-10 w-full max-w-md text-center space-y-8 animate-pop">
        <div class="inline-block bg-brand text-white text-xs font-bold px-4 py-1.5 uppercase tracking-widest transform -rotate-2 shadow-[0_0_20px_rgba(255,59,48,0.4)]">‚ö†Ô∏è Brutally Honest</div>
        <h1 class="font-display text-7xl md:text-9xl uppercase leading-[0.85] text-white">Who<br>Are<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-brand to-yellow-500">You?</span></h1>
        <p class="text-lg text-white/70 font-medium max-w-xs mx-auto leading-relaxed">22 Scenarios. 1 Brutal Roast. <br>Are you the Main Character or an NPC?</p>
        
        <button id="btn-start" class="w-full bg-white text-black font-display text-3xl uppercase py-5 hover:bg-brand hover:text-white transition-colors duration-300 shadow-2xl transform hover:scale-[1.02] tracking-wide rounded-none border border-transparent">
          GET ROASTED
        </button>

        <div class="flex justify-center gap-6 text-[10px] uppercase tracking-widest text-white/30 pt-4"><span>üì∏ Visual</span><span>üî• Adrenaline</span><span>üß™ 50 Metrics</span></div>
      </div>
    </section>

    <!-- SCREEN 2: QUIZ -->
    <section id="screen-quiz" class="hidden absolute inset-0 flex flex-col">
      <div class="absolute top-0 left-0 w-full h-1 bg-white/10 z-50"><div id="progress-fill" class="h-full bg-brand transition-all duration-300 w-0"></div></div>
      <div class="absolute top-24 left-0 right-0 z-40 flex justify-center pointer-events-none px-4"><div class="bg-black/80 backdrop-blur-xl px-8 py-4 border border-white/10 shadow-2xl transform rotate-1"><h2 id="q-prompt" class="font-display text-4xl md:text-6xl text-white uppercase tracking-wide text-center leading-none">LOADING...</h2></div></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none"><div id="vs-badge" class="bg-white text-black font-display font-bold text-4xl px-4 py-2 rotate-[-5deg] shadow-[0_0_50px_rgba(255,255,255,0.5)] transition-all duration-300">VS</div></div>
      <div class="flex flex-col md:flex-row h-full w-full">
        <button id="btn-a" class="relative flex-1 group h-1/2 md:h-full overflow-hidden focus:outline-none border-b-2 md:border-b-0 md:border-r-2 border-black"><img id="img-a" src="" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 opacity-60 group-hover:opacity-100" /><div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/50"></div><div class="absolute bottom-8 left-8 text-left z-20"><span id="label-a" class="font-display text-5xl md:text-7xl uppercase text-white leading-none shadow-black drop-shadow-lg transition-transform duration-100">...</span></div></button>
        <button id="btn-b" class="relative flex-1 group h-1/2 md:h-full overflow-hidden focus:outline-none"><img id="img-b" src="" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 opacity-60 group-hover:opacity-100" /><div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/50"></div><div class="absolute bottom-8 right-8 text-right z-20"><span id="label-b" class="font-display text-5xl md:text-7xl uppercase text-white leading-none shadow-black drop-shadow-lg transition-transform duration-100">...</span></div></button>
      </div>
    </section>

    <!-- SCREEN 3: THE GATE -->
    <section id="screen-gate" class="hidden absolute inset-0 bg-black z-50 flex items-center justify-center p-6">
      <div class="w-full max-w-md space-y-8 animate-pop">
        <div class="text-center"><h2 class="font-display text-5xl text-white uppercase mb-2">Almost There</h2><p class="text-white/60">We need to verify your identity to calculate the final roast.</p></div>
        <div class="space-y-4">
          <div><label class="text-[10px] font-bold uppercase text-brand tracking-widest mb-1 block">Your Era</label><select id="input-age"><option value="" disabled selected>Select your age...</option><option value="genz">"I'm a literal child" (<18)</option><option value="prime">"Prime of my life" (18-29)</option><option value="backpain">"My back hurts" (30-45)</option><option value="nirvana">"I saw Nirvana live" (45+)</option></select></div>
          <div><label class="text-[10px] font-bold uppercase text-brand tracking-widest mb-1 block">Your Toxic Trait</label><select id="input-toxic"><option value="" disabled selected>Be honest...</option><option value="location">I check their location on Snap maps</option><option value="ex">I text my ex when I'm drunk</option><option value="judge">I judge people's Spotify Wrapped</option><option value="gatekeep">I gatekeep bands I found yesterday</option><option value="main">I think I'm the Main Character</option></select></div>
          <div><label class="text-[10px] font-bold uppercase text-white/50 tracking-widest mb-1 block">First Concert (Optional)</label><input type="text" id="input-concert" placeholder="e.g. One Direction 2013"></div>
        </div>
        <button id="btn-reveal" class="w-full bg-white text-black font-display text-2xl uppercase py-4 hover:bg-brand hover:text-white transition-colors">REVEAL MY ROAST</button>
      </div>
    </section>

    <!-- SCREEN 4: RESULTS -->
    <section id="screen-result" class="hidden absolute inset-0 bg-[#0a0a0a] overflow-y-auto">
      <div class="min-h-full w-full flex flex-col items-center justify-center p-6 py-12">
        
        <!-- Result Card -->
        <div id="result-card" class="w-full max-w-md bg-black border border-white/10 p-8 text-center space-y-6 relative overflow-hidden animate-pop shadow-2xl">
          <div class="absolute -top-20 -right-20 w-60 h-60 bg-brand/20 blur-[80px] rounded-full pointer-events-none"></div>
          <div class="relative z-10 space-y-6">
            <div class="inline-block border border-white/20 px-3 py-1 rounded-full"><span class="text-[10px] font-bold uppercase tracking-widest text-white/50">Official Diagnosis</span></div>
            <div><h2 id="r-title" class="font-display text-6xl md:text-7xl uppercase leading-[0.9] text-white mb-4">UNKNOWN</h2><p id="r-roast" class="text-xl md:text-2xl text-brand font-bold leading-tight font-display uppercase italic">"Calculating..."</p></div>
            <div class="h-px w-full bg-white/10"></div>
            <p id="r-desc" class="text-sm text-white/70 leading-relaxed font-medium">...</p>
            <div class="pt-4 text-[10px] font-bold uppercase text-white/30 tracking-widest">vibecheck.app ‚Ä¢ 2025</div>
          </div>
        </div>

        <!-- NEW PREMIUM PLAYLIST MODAL -->
        <div id="playlist-modal" class="hidden w-full max-w-md card-glass p-8 rounded-xl fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[100]">
           <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
           
           <div class="text-center mb-8">
              <h3 id="pl-title" class="font-display text-3xl text-white uppercase tracking-wide">Your Sonic Identity</h3>
              <p id="pl-sub" class="text-xs font-mono text-white/50 mt-2 uppercase tracking-widest">10 Songs ‚Ä¢ Generated from 50 Metrics</p>
           </div>
           
           <!-- Tracklist (Blurred for Guest) -->
           <div id="playlist-tracks" class="space-y-3 mb-8 h-60 overflow-hidden relative">
              <div class="absolute inset-0 z-10 flex flex-col items-center justify-center space-y-4">
                 <div class="text-4xl text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">üîí</div>
              </div>
              <!-- Fake blurred data for effect -->
              <div class="blur-content space-y-4 opacity-30">
                 <div class="flex justify-between"><span class="w-2/3 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
                 <div class="flex justify-between"><span class="w-1/2 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
                 <div class="flex justify-between"><span class="w-3/4 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
                 <div class="flex justify-between"><span class="w-2/3 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
                 <div class="flex justify-between"><span class="w-1/2 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
                 <div class="flex justify-between"><span class="w-3/4 h-4 bg-white/50 rounded"></span><span class="w-1/4 h-4 bg-white/30 rounded"></span></div>
              </div>
           </div>
           
           <!-- Action Area -->
           <div id="playlist-actions" class="flex flex-col gap-3">
             <button onclick="handleGoogleLogin()" class="btn-gold w-full py-4 rounded text-sm font-bold uppercase tracking-widest flex items-center justify-center gap-3">
               <i class="fa-brands fa-google"></i> Unlock My Mix
             </button>
             <button onclick="document.getElementById('playlist-modal').classList.add('hidden')" class="text-[10px] text-white/30 uppercase tracking-widest hover:text-white mt-2">Close Window</button>
           </div>
        </div>

        <!-- Professional Actions -->
        <div class="mt-8 w-full max-w-md space-y-4">
          
          <!-- Share -->
          <button id="btn-share" class="btn-premium w-full bg-[#111] text-white py-4 rounded-lg flex items-center justify-center gap-2 group">
            <span class="font-display text-xl uppercase tracking-wider group-hover:text-brand transition-colors">Share Poster</span>
            <i class="fa-solid fa-share-nodes text-white/30 group-hover:text-brand transition-colors"></i>
          </button>

          <!-- Divider -->
          <div class="relative flex py-4 items-center">
             <div class="flex-grow border-t border-white/10"></div>
             <span class="flex-shrink-0 mx-4 text-white/20 text-[10px] font-bold uppercase tracking-[0.2em]">Unlock Playlist</span>
             <div class="flex-grow border-t border-white/10"></div>
          </div>

          <!-- Playlist Generator Button -->
          <button id="btn-gen-playlist" class="btn-premium w-full p-5 rounded-xl flex items-center justify-between group">
             <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-xl group-hover:bg-white/10 transition-colors">
                   üéµ
                </div>
                <div class="text-left">
                   <div id="pl-btn-title" class="font-bold text-sm uppercase tracking-wide text-white">Generate Playlist</div>
                   <div id="pl-btn-sub" class="text-[10px] text-white/40 group-hover:text-white/60 transition-colors">Based on your 50 data points</div>
                </div>
             </div>
             <div id="pl-lock-icon" class="text-white/20 group-hover:text-white transition-colors">
                <i class="fa-solid fa-chevron-right"></i>
             </div>
          </button>

          <!-- Auth & Sync -->
          <div id="viewGuestAuth" class="bg-black border border-white/10 rounded-xl p-6 space-y-4 shadow-xl">
             <div class="text-center text-[10px] text-white/40 font-bold uppercase tracking-widest mb-2">Sync Results to Cloud</div>
             
             <!-- Google Sign In -->
             <button onclick="handleGoogleLogin()" class="btn-premium w-full bg-white text-black py-3 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-100">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-4 h-4" alt="Google">
                <span class="text-xs font-bold uppercase tracking-wide">Continue with Google</span>
             </button>

             <!-- Email Toggle -->
             <div class="text-center">
                <button onclick="document.getElementById('emailForm').classList.toggle('hidden')" class="text-[10px] text-white/30 hover:text-white underline decoration-white/30">Or use email/password</button>
             </div>

             <!-- Hidden Email Form -->
             <div id="emailForm" class="hidden space-y-3 pt-2">
                <input id="emailInput" type="email" placeholder="Email Address" class="bg-[#111] border border-white/10 text-white text-xs rounded p-3 w-full focus:border-white/50 placeholder-white/20">
                <input id="passInput" type="password" placeholder="Password" class="bg-[#111] border border-white/10 text-white text-xs rounded p-3 w-full focus:border-white/50 placeholder-white/20">
                <div class="flex gap-2">
                   <button onclick="handleEmailLogin()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded text-xs font-bold uppercase transition-colors">Login</button>
                   <button onclick="handleEmailSignup()" class="flex-1 bg-brand hover:bg-red-600 text-white py-2 rounded text-xs font-bold uppercase transition-colors">Register</button>
                </div>
             </div>
             <div id="authError" class="text-brand text-xs font-bold hidden text-center uppercase tracking-wide"></div>
          </div>

          <button id="btn-again" class="w-full text-white/20 text-[10px] font-mono py-2 hover:text-white transition-colors uppercase tracking-widest">
             [ Restart Analysis ]
          </button>

        </div>
      </div>
    </section>
  </main>

  <canvas id="share-canvas" width="1080" height="1920" class="hidden"></canvas>

  <!-- Firebase Logic Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    let db;
    let auth;
    let appId;
    
    // --- AUTH LOGIC (Globally Exposed) ---
    window.handleGoogleLogin = async () => {
      // Ensure auth exists
      if (!window.auth) {
         console.error("Auth not ready yet.");
         return;
      }
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(window.auth, provider);
        // UI updates automatically via onAuthStateChanged
      } catch (e) {
        console.error(e);
        const errDiv = document.getElementById('authError');
        if(errDiv) {
            errDiv.innerText = "Error: " + e.message;
            errDiv.classList.remove('hidden');
        }
      }
    };

    window.handleEmailLogin = async () => {
      const email = document.getElementById('emailInput').value;
      const pass = document.getElementById('passInput').value;
      if(!email || !pass) return;
      try {
        await signInWithEmailAndPassword(window.auth, email, pass);
      } catch (e) {
        document.getElementById('authError').innerText = e.message;
        document.getElementById('authError').classList.remove('hidden');
      }
    };

    window.handleEmailSignup = async () => {
      const email = document.getElementById('emailInput').value;
      const pass = document.getElementById('passInput').value;
      if(!email || !pass) return;
      try {
        await createUserWithEmailAndPassword(window.auth, email, pass);
      } catch (e) {
        document.getElementById('authError').innerText = e.message;
        document.getElementById('authError').classList.remove('hidden');
      }
    };

    // --- INITIALIZATION ---
    try {
      if (typeof __firebase_config !== 'undefined') {
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // GLOBAL EXPORT
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.fsCollection = collection;
        window.fsAddDoc = addDoc;

        onAuthStateChanged(auth, (user) => {
          if (user) {
            window.currentUser = user;
            if(!user.isAnonymous) {
               // Update UI for Signed In User
               const authBlock = document.getElementById('viewGuestAuth');
               if(authBlock) authBlock.innerHTML = '<div class="text-center text-toxic text-xs font-bold uppercase tracking-widest py-4 border border-toxic/30 bg-toxic/5 rounded-lg">‚úì Cloud Account Active</div>';
               
               // Unlock Playlist Button Visuals
               const lockIcon = document.getElementById('pl-lock-icon');
               if(lockIcon) lockIcon.innerHTML = '<i class="fa-solid fa-unlock text-toxic"></i>';
               
               const btnTitle = document.getElementById('pl-btn-title');
               if(btnTitle) btnTitle.innerText = "Access Premium Playlist";
               
               // Re-save data
               if(window.lastPersona && window.saveToFirebase) {
                   window.saveToFirebase({...window.lastPersona});
               }
            }
          } else {
            signInAnonymously(auth).catch((error) => console.error("Guest login failed", error));
          }
        });
      }
    } catch (e) {
      console.warn("Firebase config missing or invalid.", e);
    }

    // --- SAVE LOGIC ---
    window.saveToFirebase = async (data) => {
      if (!window.db || !window.auth || !window.auth.currentUser) return;
      try {
        let ip = 'unknown';
        try { const res = await fetch('https://api.ipify.org?format=json'); const json = await res.json(); ip = json.ip; } catch(e) {}

        const payload = {
          ...data,
          userId: window.auth.currentUser.uid,
          isAnonymous: window.auth.currentUser.isAnonymous,
          email: window.auth.currentUser.email || null,
          ip: ip,
          timestamp: new Date().toISOString()
        };

        await window.fsAddDoc(window.fsCollection(window.db, 'artifacts', window.appId, 'public', 'data', 'roast_results'), payload);
        console.log("Data saved to Firebase!");
      } catch (e) {
        console.error("Error saving to Firebase: ", e);
      }
    };
  </script>

  <script>
    const QUESTIONS = [
      { id: 1, prompt: "THE KING?", a: { label: "MJ", img: "https://images.unsplash.com/photo-1504593811423-6dd665756598?q=80&w=1000", score: { pop: 2, classic: 1 } }, b: { label: "PRINCE", img: "https://images.unsplash.com/photo-1549834125-9a69624c9c7c?q=80&w=1000", score: { music_snob: 2, funk: 1 } } },
      { id: 2, prompt: "THE VENUE?", a: { label: "THE CLUB", img: "https://images.unsplash.com/photo-1566737236500-c8ac43014a67?q=80&w=1000", score: { party: 2, chaos: 1 } }, b: { label: "COZY BAR", img: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?q=80&w=1000", score: { indie: 2, chill: 1 } } },
      { id: 3, prompt: "THE BEEF?", a: { label: "KANYE", img: "https://images.unsplash.com/photo-1549490349-8643362247b5?q=80&w=1000", score: { chaos: 2, ego: 2 } }, b: { label: "TAYLOR", img: "https://images.unsplash.com/photo-1621360841013-c768371e93cf?q=80&w=1000", score: { pop: 2, order: 1 } } },
      { id: 4, prompt: "THE ERA?", a: { label: "90s", img: "https://images.unsplash.com/photo-1598518141892-06ba05f87bbe?q=80&w=1000", score: { nostalgia: 2, classic: 1 } }, b: { label: "2016", img: "https://images.unsplash.com/photo-1496337589254-7e19d01cec44?q=80&w=1000", score: { modern: 1, party: 2 } } },
      { id: 5, prompt: "THE MOOD?", a: { label: "CRYING IN UBER", img: "https://images.unsplash.com/photo-1517070208541-6ddc4d3efbcb?q=80&w=1000", score: { sad: 2, main_character: 1 } }, b: { label: "ON THE TABLE", img: "https://images.unsplash.com/photo-1524368535928-5b5e00ddc76b?q=80&w=1000", score: { party: 2, chaos: 1 } } },
      { id: 6, prompt: "THE FAME?", a: { label: "STADIUMS", img: "https://images.unsplash.com/photo-1459749411177-2a2965eec0a5?q=80&w=1000", score: { pop: 2, sellout: 1 } }, b: { label: "BASEMENT", img: "https://images.unsplash.com/photo-1574169208507-84376144848b?q=80&w=1000", score: { indie: 2, music_snob: 1 } } },
      { id: 7, prompt: "PSYCHO CHECK?", a: { label: "GOD COMPLEX", img: "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=1000", score: { ego: 2, toxic: 1 } }, b: { label: "VICTIM COMPLEX", img: "https://images.unsplash.com/photo-1509909756405-be0199881695?q=80&w=1000", score: { sad: 2, toxic: 1 } } },
      { id: 8, prompt: "FUEL?", a: { label: "ICED COFFEE", img: "https://images.unsplash.com/photo-1517701604599-bb29b5c7dd90?q=80&w=1000", score: { chill: 1, influencer: 1 } }, b: { label: "VODKA REDBULL", img: "https://images.unsplash.com/photo-1546171753-97d7676e4602?q=80&w=1000", score: { party: 2, chaos: 2 } } },
      { id: 9, prompt: "SOURCE?", a: { label: "VINYL", img: "https://images.unsplash.com/photo-1603048588665-791ca8aea616?q=80&w=1000", score: { music_snob: 2, classic: 1 } }, b: { label: "AIRPODS", img: "https://images.unsplash.com/photo-1505236273191-1dce886b01e9?q=80&w=1000", score: { modern: 2, convenience: 1 } } },
      { id: 10, prompt: "FLAGS?", a: { label: "RED FLAGS", img: "https://images.unsplash.com/photo-1505330622279-bf7d7fc918f4?q=80&w=1000", score: { toxic: 2, chaos: 1 } }, b: { label: "GREEN FLAGS", img: "https://images.unsplash.com/photo-1550989460-0adf9ea622e2?q=80&w=1000", score: { wholesome: 2, order: 1 } } },
      { id: 11, prompt: "HABIT?", a: { label: "TEXT FIRST", img: "https://images.unsplash.com/photo-1577563908411-5077b6dc7624?q=80&w=1000", score: { confidence: 1, anxiety: 1 } }, b: { label: "WAIT FOR THEM", img: "https://images.unsplash.com/photo-1515023115689-589c33041697?q=80&w=1000", score: { ego: 2, toxic: 1 } } },
      { id: 12, prompt: "PRIORITY?", a: { label: "LYRICS", img: "https://images.unsplash.com/photo-1455390582262-044cdead277a?q=80&w=1000", score: { emotional: 2, sad: 1 } }, b: { label: "BEAT", img: "https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=1000", score: { dance: 2, party: 1 } } },
      { id: 13, prompt: "SPEED?", a: { label: "FAST", img: "https://images.unsplash.com/photo-1535581652167-3d6b98636db2?q=80&w=1000", score: { energy: 3, chaos: 1 }, anim: "shake" }, b: { label: "SLOW", img: "https://images.unsplash.com/photo-1504198458649-3128b932f49e?q=80&w=1000", score: { chill: 2, sad: 1 }, anim: "breathe" } },
      { id: 14, prompt: "VIBE?", a: { label: "CHAOS", img: "https://images.unsplash.com/photo-1500462918059-b1a0cb512f1d?q=80&w=1000", score: { chaos: 3 } }, b: { label: "ORDER", img: "https://images.unsplash.com/photo-1487215078519-e24265f1d896?q=80&w=1000", score: { order: 2 } } },
      { id: 15, prompt: "VOLUME?", a: { label: "SCREAM", img: "https://images.unsplash.com/photo-1545959570-a94770252b6d?q=80&w=1000", score: { energy: 2, rock: 2 } }, b: { label: "WHISPER", img: "https://images.unsplash.com/photo-1476994230281-1448088947db?q=80&w=1000", score: { intimacy: 2, asmr: 1 } } },
      { id: 16, prompt: "TIME?", a: { label: "FUTURE", img: "https://images.unsplash.com/photo-1485827404703-89b55fcc595e?q=80&w=1000", score: { modern: 2 } }, b: { label: "NOSTALGIA", img: "https://images.unsplash.com/photo-1518546305927-5a555bb7020d?q=80&w=1000", score: { nostalgia: 2 } } },
      { id: 17, prompt: "RISK?", a: { label: "DELETE HISTORY", img: "https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=1000", score: { toxic: 2 } }, b: { label: "POST DRAFTS", img: "https://images.unsplash.com/photo-1611162617474-5b21e879e113?q=80&w=1000", score: { confidence: 2, chaos: 1 } } },
      { id: 18, prompt: "SETTING?", a: { label: "DAY", img: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1000", score: { wholesome: 2 } }, b: { label: "NIGHT", img: "https://images.unsplash.com/photo-1478760329108-5c3ed9d495a0?q=80&w=1000", score: { dark: 2, party: 1 } } },
      { id: 19, prompt: "DANGER?", a: { label: "CALLING MOM", img: "https://images.unsplash.com/photo-1563223552-30d01cd4ea7d?q=80&w=1000", score: { wholesome: 2 } }, b: { label: "CALLING EX", img: "https://images.unsplash.com/photo-1620843437920-3add20509a27?q=80&w=1000", score: { toxic: 3, chaos: 2 } } },
      { id: 20, prompt: "DRIVE?", a: { label: "LOVE", img: "https://images.unsplash.com/photo-1518621736915-f3b1c41bfd00?q=80&w=1000", score: { romance: 2 } }, b: { label: "LUST", img: "https://images.unsplash.com/photo-1496345648354-9e320d36c539?q=80&w=1000", score: { party: 1, energy: 1 } } },
      { id: 21, prompt: "STATUS?", a: { label: "RICH & SAD", img: "https://images.unsplash.com/photo-1608848461950-0fe51dfc41cb?q=80&w=1000", score: { sad: 2, ego: 1 } }, b: { label: "BROKE & HAPPY", img: "https://images.unsplash.com/photo-1513151233558-d860c5398176?q=80&w=1000", score: { wholesome: 2, chill: 2 } } },
      { id: 22, prompt: "GOAL?", a: { label: "FAMOUS", img: "https://images.unsplash.com/photo-1501386761578-eac5c94b800a?q=80&w=1000", score: { ego: 2, main_character: 2 } }, b: { label: "INVISIBLE", img: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1000", score: { indie: 2, mystery: 2 } } }
    ];

    const state = {
      idx: 0,
      scores: {
        pop:0, classic:0, toxic:0, modern:0, party:0, chaos:0, music_snob:0, sad:0, indie:0, confidence:0, rock:0, electronic:0, cool:0, influencer:0, techno:0, dark:0, ego:0, wholesome:0, order:0, romance:0, main_character:0, funk:0, chill:0, nostalgia:0, sellout:0, convenience:0, anxiety:0, emotional:0, dance:0, energy:0, intimacy:0, asmr:0, mystery:0
      },
      gateData: { age: null, toxic: null }
    };

    const el = (id) => document.getElementById(id);

    function init() {
      state.idx = 0;
      for(let k in state.scores) state.scores[k] = 0;
      document.body.className = "mode-normal font-sans antialiased h-screen flex flex-col";
      el('mode-badge').innerHTML = '<span class="text-[10px] font-bold uppercase tracking-widest text-white/80">Culture Roast</span>';
      el('vs-badge').style.backgroundColor = "white";
      el('vs-badge').style.color = "black";
      el('vs-badge').innerText = "VS";
      el('debug-view').classList.add('hidden');
      showScreen('screen-landing');
    }

    function showScreen(id) {
      ['screen-landing', 'screen-quiz', 'screen-gate', 'screen-result'].forEach(s => el(s).classList.add('hidden'));
      el(id).classList.remove('hidden');
    }

    function renderQuestion() {
      if (state.idx === 12) triggerAdrenalineMode();
      if (state.idx >= QUESTIONS.length) { showScreen('screen-gate'); return; }
      const q = QUESTIONS[state.idx];
      el('q-prompt').innerText = q.prompt;
      updateBtn('a', q.a);
      updateBtn('b', q.b);
      el('progress-fill').style.width = `${((state.idx + 1) / QUESTIONS.length) * 100}%`;
    }

    function updateBtn(side, data) {
      el(`label-${side}`).innerText = data.label;
      el(`img-${side}`).src = data.img;
      el(`label-${side}`).className = `font-display text-5xl md:text-7xl uppercase text-white leading-none shadow-black drop-shadow-lg transition-transform duration-100 ${data.anim ? 'animate-' + data.anim : ''}`;
    }

    function triggerAdrenalineMode() {
      document.body.className = "mode-adrenaline font-sans antialiased h-screen flex flex-col";
      el('mode-badge').innerHTML = '<span class="text-[10px] font-bold uppercase tracking-widest text-brand animate-pulse">‚ö†Ô∏è ADRENALINE MODE</span>';
      el('mode-badge').classList.add('bg-black', 'border', 'border-brand');
      el('vs-badge').style.backgroundColor = "#FF3B30";
      el('vs-badge').style.color = "white";
      el('vs-badge').innerText = "‚ö°Ô∏è";
    }

    function handleChoice(choice) { 
      const q = QUESTIONS[state.idx];
      const scoresToAdd = q[choice].score;
      for (let key in scoresToAdd) {
        if (state.scores[key] !== undefined) state.scores[key] += scoresToAdd[key];
      }
      state.idx++;
      renderQuestion();
    }

    function revealResult() {
      const age = el('input-age').value;
      const toxic = el('input-toxic').value;
      if(!age || !toxic) { alert("We need to know who we're roasting. Fill in the info."); return; }
      state.gateData = { age, toxic };
      finish();
    }

    function getPersona() {
      const s = state.scores;
      if (s.toxic > 5) return { title: "The Red Flag", roast: "You need therapy, not a playlist.", desc: "You chose toxicity every time. You text your ex, you listen to Drake, and you probably think gaslighting is a love language." };
      if (s.ego > 4) return { title: "Main Character", roast: "The world does not revolve around you.", desc: "You walk around listening to music pretending you're in a movie edit. You aren't. Please stop looking at yourself in store windows." };
      if (s.sad > 5) return { title: "Sad Girl", roast: "Go to therapy.", desc: "You romanticize your own suffering for the aesthetic. Crying in an Uber isn't a personality trait, it's a cry for help." };
      if (s.music_snob > 4) return { title: "Vinyl Snob", roast: "Nobody cares about your vinyls.", desc: "You hate popular things just because they're popular. You probably talk over people to explain why Tame Impala is actually just one guy." };
      return { title: "The NPC", roast: "You have default settings.", desc: "Your taste is incredibly safe. You probably think drinking water is 'self-care' and your favorite artist is 'whoever is on the radio'." };
    }

    function generateLocalPlaylist(scores) {
        // Simple playlist mapping
        const library = {
            toxic: ["The Weeknd - The Hills", "Drake - Marvins Room", "Future - Mask Off", "SZA - Kill Bill", "Brent Faiyaz - Poison", "Jhene Aiko - The Worst", "Doja Cat - Streets", "Chase Atlantic - Swim", "Arctic Monkeys - Do I Wanna Know?", "Gnarls Barkley - Crazy"],
            sad: ["Lana Del Rey - Video Games", "Mitski - Washing Machine Heart", "Joji - Glimpse of Us", "Phoebe Bridgers - Motion Sickness", "Frank Ocean - White Ferrari", "Bon Iver - Holocene", "Billie Eilish - when the party's over", "Radiohead - Creep", "Olivia Rodrigo - Traitor", "Conan Gray - Heather"],
            party: ["Fred again.. - Marea", "Fisher - Losing It", "Dom Dolla - Rhyme Dust", "Calvin Harris - Miracle", "Peggy Gou - It Goes Like Nanana", "Dua Lipa - Levitating", "Disclosure - Latch", "Ti√´sto - The Business", "David Guetta - I'm Good", "Skrillex - Rumble"]
        };
        const topTrait = Object.entries(scores).sort((a,b) => b[1] - a[1])[0][0];
        return (library[topTrait] || library.party).slice(0, 10);
    }

    function handlePlaylistGen() {
        const modal = document.getElementById('playlist-modal');
        const container = document.getElementById('playlist-tracks');
        const isLoggedIn = window.auth && window.auth.currentUser && !window.auth.currentUser.isAnonymous;
        
        modal.classList.remove('hidden');
        
        if (isLoggedIn) {
            // PREMIUM STATE
            const tracks = generateLocalPlaylist(state.scores);
            const playlistId = "#VIBE-" + Math.floor(Math.random()*10000);
            container.innerHTML = `
                 <div class="text-center text-xs text-gold mb-4 font-bold uppercase tracking-widest border border-gold/30 bg-gold/10 py-2 rounded">‚òÖ Premium Access Unlocked</div>
                 <div class="space-y-3">
                     ${tracks.map((t, i) => `<div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="text-white text-xs font-mono"><span class="text-white/30 mr-2">${String(i+1).padStart(2,'0')}</span> ${t}</span>
                     </div>`).join('')}
                 </div>
                 <div class="mt-6 flex flex-col gap-2">
                    <button onclick="window.open('https://www.youtube.com/results?search_query=${encodeURIComponent(getPersona().title + " Playlist")}', '_blank')" class="w-full bg-[#FF0000] text-white font-bold py-3 rounded text-xs uppercase hover:brightness-110 flex items-center justify-center gap-2 shadow-lg">
                       <i class="fa-brands fa-youtube text-lg"></i> Open Mix on YouTube
                    </button>
                    <button onclick="window.open('https://open.spotify.com/search/${encodeURIComponent(getPersona().title + " Mix")}', '_blank')" class="w-full bg-[#1DB954] text-white font-bold py-3 rounded text-xs uppercase hover:brightness-110 flex items-center justify-center gap-2 shadow-lg">
                       <i class="fa-brands fa-spotify text-lg"></i> Open on Spotify
                    </button>
                 </div>
            `;
            // Remove the login buttons from modal if logged in
            document.getElementById('playlist-actions').classList.add('hidden');
        } else {
            // GUEST STATE - LOCKED VIEW
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center space-y-4 py-8">
                    <div class="text-5xl drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]">üîí</div>
                    <div class="text-center space-y-2">
                        <div class="text-white font-bold uppercase text-sm tracking-wide">Playlist Locked</div>
                        <div class="text-white/50 text-xs px-6 blur-[2px] select-none">
                           1. The Weeknd - Hills<br>
                           2. Drake - Marvins Room<br>
                           3. ??? - ???<br>
                           4. ??? - ???
                        </div>
                    </div>
                </div>
            `;
            // Show login buttons
            document.getElementById('playlist-actions').classList.remove('hidden');
        }
    }

    el('btn-gen-playlist').addEventListener('click', handlePlaylistGen);

    function finish() {
      const p = getPersona();
      window.lastPersona = p;
      el('r-title').innerText = p.title;
      el('r-roast').innerText = `"${p.roast}"`;
      el('r-desc').innerText = p.desc;
      
      // Auto-save if possible
      if (window.saveToFirebase) window.saveToFirebase({ scores: state.scores, gateData: state.gateData, result: p });
      
      showScreen('screen-result');
    }

    // Wiring up basic events
    el('btn-start').addEventListener('click', () => { showScreen('screen-quiz'); renderQuestion(); });
    el('btn-a').addEventListener('click', () => handleChoice('a'));
    el('btn-b').addEventListener('click', () => handleChoice('b'));
    el('btn-reveal').addEventListener('click', revealResult);
    el('btn-again').addEventListener('click', init);
    el('btn-share').addEventListener('click', () => alert("Share feature implementation needed (Canvas/Image gen)"));
    el('btn-debug').addEventListener('click', () => { el('debug-view').classList.toggle('hidden'); });

  </script>
</body>
</html>