<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-ML3F7KLZ');</script>
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
      }
    }
    </script>

    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="game-engine.js"></script> 
    <script src="components.js" defer></script> 

    <link rel="icon" type="image/png" sizes="192x192" href="assets/favicon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Big Bang Theory Personality Test | QuizRealm</title>
    <meta name="description" content="Which Big Bang Theory character are you? Take this psychological assessment to find out if you are a Sheldon, Penny, Leonard, or Howard.">
    
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#020617">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@300;400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'], 
                        arcade: ['Bungee', 'cursive'],
                        mono: ['Share Tech Mono', 'monospace']
                    },
                    colors: {
                        tbbtBlue: '#3b82f6',
                        tbbtYellow: '#fbbf24',
                        tbbtRed: '#ef4444',
                        bgDark: '#020617',
                        storeBlue: '#66c0f4',
                        storeGreen: '#a4d007',
                        storeHighlight: '#1e293b'
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #050505; 
            background-image: radial-gradient(circle at 50% 0%, #172554, #050505 80%);
            min-height: 100vh; 
            color: #e2e8f0;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.6);
        }
        .atom-orbit { animation: spin-slow 10s linear infinite; }
        .option-btn:hover { transform: translateX(4px); border-color: #fbbf24; }
        
        .hero-banner {
            height: 450px; width: 100%; overflow: hidden; position: relative;
            border-radius: 24px; margin-bottom: 40px; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hero-banner img {
            width: 100%; height: 100%; object-fit: cover;
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }
        .hero-banner .content-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 40px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        .share-card-container {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            padding: 15px;
            margin-top: 20px;
        }
        .btn-play {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s;
            color: white;
            padding: 10px 15px;
            font-family: 'Outfit', sans-serif;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            border: none;
            font-weight: 700;
            font-size: 0.8rem;
        }
        .btn-play:hover { background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%); }
        .feedback-msg { transition: opacity 0.3s; color: #a4d007; font-size: 0.75rem; margin-top: 5px; text-align: center; }
    </style>
</head>

<body class="flex flex-col antialiased">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-ML3F7KLZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <quiz-header></quiz-header>

    <main class="flex-grow w-full max-w-4xl mx-auto px-4 py-10">

        <div id="introScreen" class="animate-fade-in">
            
            <div class="hero-banner shadow-2xl border border-white/10">
                <img src="assets/tbbtperson.webp" alt="The Big Bang Theory Cast">
                <div class="content-overlay"></div>
            </div>

            <div class="text-center">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full atom-orbit"></div>
                    <div class="absolute inset-0 border-4 border-yellow-500/30 rounded-full atom-orbit" style="animation-direction: reverse; width: 110%; left: -5%;"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-4xl">
                        <i class="fas fa-atom text-cyan-400"></i>
                    </div>
                </div>

                <h1 class="font-arcade text-4xl md:text-6xl text-white mb-6 leading-none">
                    The <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-400">Paradigm</span> Shift
                </h1>
                
                <p class="text-slate-400 text-lg max-w-2xl mx-auto leading-relaxed mb-10">
                    Are you a visionary theoretical physicist or a practical engineer? A hopeless romantic or a neurobiological realist? Engage our <strong>social calibration algorithm</strong> to determine your true archetype.
                </p>

                <button onclick="startQuiz()" class="group relative inline-flex items-center justify-center px-10 py-4 font-bold text-white transition-all duration-200 bg-blue-600 font-sans rounded-full hover:bg-blue-500 hover:shadow-[0_0_30px_rgba(59,130,246,0.5)] hover:-translate-y-1 mb-8">
                    <span class="mr-2">INITIATE TEST</span> <i class="fas fa-flask"></i>
                </button>

                <div class="share-card-container mx-auto max-w-sm text-left">
                    <h4 class="text-white font-bold text-xs mb-2 flex items-center gap-2 border-b border-white/10 pb-2">
                        <i class="fas fa-users text-tbbtYellow"></i> CHALLENGE YOUR COHORT
                    </h4>
                    <p class="text-slate-400 text-xs mb-3">Who is the 'Sheldon' of your group?</p>
                    <div class="flex gap-2">
                        <button id="start-native-btn" class="flex-1 btn-play shadow-md flex items-center justify-center gap-2">
                            <i class="fas fa-share-nodes"></i> Share Quiz
                        </button>
                        <button id="start-copy-btn" class="flex-grow-0 px-4 flex items-center justify-center rounded-lg bg-white/10 text-gray-300 hover:bg-white/20 transition" title="Copy Link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    <div id="start-copy-feedback" class="feedback-msg" style="opacity: 0;">Link copied!</div>
                </div>
                <div class="mt-8 flex justify-center gap-4 text-[10px] text-slate-500 uppercase tracking-widest">
                    <span><i class="fas fa-check text-green-500"></i> 10 Questions</span>
                    <span><i class="fas fa-check text-green-500"></i> Scientific Logic</span>
                    <span><i class="fas fa-check text-green-500"></i> 100% Bazinga</span>
                </div>
            </div>
        </div>

        <div id="quizInterface" class="hidden max-w-2xl mx-auto mt-10">
            <div class="flex justify-between items-end mb-4 px-1">
                <span class="text-xs text-blue-400 font-mono font-bold tracking-widest">DATA COLLECTION</span>
                <span class="text-xs font-bold text-white" id="progressText">1 / 10</span>
            </div>
            
            <div class="h-1 w-full bg-slate-800/50 rounded-full mb-8 overflow-hidden">
                <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-500" style="width: 10%"></div>
            </div>

            <div class="glass-card rounded-2xl p-6 md:p-10 relative">
                <h2 class="text-xl md:text-2xl font-bold text-white mb-8 leading-snug" id="questionText">Loading...</h2>
                <div class="space-y-3" id="optionsGrid"></div>
            </div>
        </div>

        <div id="analyzingScreen" class="hidden text-center min-h-[50vh] flex flex-col justify-center">
            <i class="fas fa-dna text-5xl text-blue-500 animate-bounce mb-6"></i>
            <h2 class="font-mono text-xl text-cyan-400 animate-pulse-fast" id="analyzingText">
                ANALYZING SOCIAL CUES...
            </h2>
            <p class="text-slate-500 text-sm mt-2">Please wait while we calibrate your sarcasm levels.</p>
        </div>

        <div id="resultsScreen" class="hidden max-w-2xl mx-auto mt-10">
            
            <div class="glass-card rounded-2xl overflow-hidden border-t-4 border-t-yellow-500 mb-8">
                <div class="p-8 text-center bg-gradient-to-b from-blue-900/20 to-transparent">
                    <p class="text-xs font-bold text-yellow-500 uppercase tracking-[0.2em] mb-3">Assessment Complete</p>
                    <h1 class="font-arcade text-4xl md:text-5xl text-white mb-2" id="resultTitle">...</h1>
                    <div id="resultTags" class="flex justify-center gap-2 mb-6 flex-wrap"></div>
                    <p class="text-slate-300 text-base leading-relaxed" id="resultDesc">...</p>
                </div>
                
                <div class="grid grid-cols-2 border-t border-white/5 divide-x divide-white/5 bg-black/20">
                    <div class="p-4 text-center">
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Superpower</div>
                        <div class="text-sm font-bold text-green-400" id="resultPower">...</div>
                    </div>
                    <div class="p-4 text-center">
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Weakness</div>
                        <div class="text-sm font-bold text-red-400" id="resultWeakness">...</div>
                    </div>
                </div>
            </div>

            <div class="share-card-container mb-8">
                <h4 class="text-white font-bold text-sm mb-3 flex items-center gap-2 border-b border-white/10 pb-2">
                    <i class="fas fa-share-nodes text-tbbtBlue"></i> PUBLISH FINDINGS
                </h4>
                <p id="result-share-text" class="text-sm text-slate-400 mb-4">Show off your archetype!</p>

                <div class="flex gap-3">
                    <button id="res-native-btn" class="flex-1 btn-play shadow-md flex items-center justify-center gap-2">
                        <i class="fas fa-share-square"></i> Share Result
                    </button>
                    <button id="res-copy-btn" class="flex-grow-0 px-4 flex items-center justify-center rounded-lg bg-white/10 text-gray-300 hover:bg-white/20 transition" title="Copy Link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
                <div id="res-copy-feedback" class="feedback-msg" style="opacity: 0;">Link copied!</div>
            </div>
            <div class="flex gap-4 justify-center">
                <button onclick="location.reload()" class="px-6 py-3 rounded-xl border border-white/20 text-white hover:bg-white/5 transition font-bold text-sm">
                    Recalibrate
                </button>
                <a href="categories.html" class="px-6 py-3 rounded-xl bg-blue-600 text-white hover:bg-blue-500 transition font-bold text-sm shadow-lg shadow-blue-900/50">
                    More Quizzes
                </a>
            </div>

        </div>

        <article class="mt-24 border-t border-white/10 pt-16 max-w-3xl mx-auto">
            <header class="text-center mb-10">
                <span class="text-blue-500 font-bold tracking-widest uppercase text-xs">Behind the Science</span>
                <h2 class="text-3xl font-bold text-white mt-2">The Psychology of the Pasadena Gang</h2>
            </header>
            
            <div class="prose prose-invert prose-slate max-w-none text-sm md:text-base leading-relaxed">
                <p>
                    <em>The Big Bang Theory</em> wasn't just a sitcom; it was a longitudinal study on social dynamics among highly intelligent but socially divergent individuals. This quiz uses a simplified version of the <strong>Big Five Personality Traits</strong> mapped to the core cast members.
                </p>
                </div>
        </article>

    </main>

    <quiz-footer></quiz-footer>

    <script>
        // --- SHARE LOGIC ---
        function initShareButtons() {
            const startUrl = window.location.href;
            const startTitle = "TBBT Personality Assessment";
            const startMsg = "My hypothesis: I'm the Sheldon of my group. Who are you? Take this TBBT personality test to find out! ➡️ " + startUrl;

            const startNativeBtn = document.getElementById('start-native-btn');
            const startCopyBtn = document.getElementById('start-copy-btn');
            
            if (navigator.share) {
                startNativeBtn.onclick = () => {
                    navigator.share({ title: startTitle, text: startMsg, url: startUrl })
                    .catch(err => { if(err.name !== 'AbortError') console.error(err); });
                };
            } else {
                startNativeBtn.onclick = () => copyText(startUrl, 'start-copy-feedback');
                startNativeBtn.innerText = "Copy Link";
            }
            startCopyBtn.onclick = () => copyText(startUrl, 'start-copy-feedback');
        }

        function setupResultShare(charName, title) {
            const url = window.location.href;
            const shareTitle = `I am ${charName}! - TBBT Quiz`;
            const msg = `Bazinga! I got ${charName}. Can you handle my intellect? Take the test here: ➡️ ` + url;

            const resNativeBtn = document.getElementById('res-native-btn');
            const resCopyBtn = document.getElementById('res-copy-btn');
            document.getElementById('result-share-text').innerText = `You are ${charName}. Share your data!`;

            if (navigator.share) {
                resNativeBtn.onclick = () => {
                    navigator.share({ title: shareTitle, text: msg, url: url })
                    .catch(err => { if(err.name !== 'AbortError') console.error(err); });
                };
            } else {
                resNativeBtn.onclick = () => copyText(url, 'res-copy-feedback');
                resNativeBtn.innerText = "Copy Link";
            }
            resCopyBtn.onclick = () => copyText(url, 'res-copy-feedback');
        }

        function copyText(text, feedbackId) {
            navigator.clipboard.writeText(text).then(() => {
                const el = document.getElementById(feedbackId);
                el.style.opacity = 1;
                setTimeout(() => el.style.opacity = 0, 2000);
            }).catch(err => console.error(err));
        }

        // Init Start Share
        document.addEventListener('DOMContentLoaded', initShareButtons);

        // --- QUESTION DATABASE ---
        const questions = [
            { q: "A friend cancels plans at the last minute. You:", a: [
                { txt: "The schedule is ruined. I must recalculate my entire evening.", val: "A" },
                { txt: "It's fine. I'll just keep working on my current project.", val: "B" },
                { txt: "I'm relieved. Time for wine and a movie marathon.", val: "C" },
                { txt: "I'll go home and play games until my mom calls.", val: "D" },
                { txt: "I don't mind. I had a long conversation with myself planned.", val: "E" },
                { txt: "I must analyze the validity of their excuse.", val: "F" },
                { txt: "That's rude. I'll make a mental note to dock them points.", val: "G" }
            ]},
            { q: "Your dream home interior is:", a: [
                { txt: "A fortress with labeled chairs and optimal Wi-Fi.", val: "A" },
                { txt: "Cozy, nerdy, and functional for experiments.", val: "B" },
                { txt: "Trendy, stylish, and comfortable for entertaining.", val: "C" },
                { txt: "A colorful shrine to geek culture and toys.", val: "D" },
                { txt: "Minimalist, quiet, and perfect for meditation.", val: "E" },
                { txt: "A place for deep thought and harp practice.", val: "F" },
                { txt: "Practical, neat, and highly efficient.", val: "G" }
            ]},
            { q: "In a heated argument, your strategy is:", a: [
                { txt: "State 'I am right' and provide a citation.", val: "A" },
                { txt: "Apologize just to make the yelling stop.", val: "B" },
                { txt: "Get loud and threaten bodily harm (jokingly).", val: "C" },
                { txt: "Make an inappropriate joke to break tension.", val: "D" },
                { txt: "Whisper your anger to a friend later.", val: "E" },
                { txt: "Wait for a logical fallacy and exploit it.", val: "F" },
                { txt: "Win. By any means necessary.", val: "G" }
            ]},
            { q: "You find a rare comic book. You:", a: [
                { txt: "Archive it immediately in a mylar bag.", val: "A" },
                { txt: "Gift it to a friend who loves it.", val: "B" },
                { txt: "Sell it online for shoe money.", val: "C" },
                { txt: "Keep it to impress your friends.", val: "D" },
                { txt: "Stare at it silently for an hour.", val: "E" },
                { txt: "Analyze the societal impact of the hero.", val: "F" },
                { txt: "Hide it so no one messes up the house.", val: "G" }
            ]},
            { q: "Your biggest fear is:", a: [
                { txt: "Germs, birds, and changing barbers.", val: "A" },
                { txt: "Disappointing the people I look up to.", val: "B" },
                { txt: "Being broke and failing my dreams.", val: "C" },
                { txt: "Moving out of my comfort zone.", val: "D" },
                { txt: "Talking to people without liquid courage.", val: "E" },
                { txt: "Being exposed as socially average.", val: "F" },
                { txt: "Being wrong about anything.", val: "G" }
            ]},
            { q: "Your approach to romance:", a: [
                { txt: "I require a signed Relationship Agreement.", val: "A" },
                { txt: "I try really hard to make them happy.", val: "B" },
                { txt: "Casual, fun, and spontaneous.", val: "C" },
                { txt: "Overly dramatic and a bit desperate.", val: "D" },
                { txt: "I fall in love way too fast.", val: "E" },
                { txt: "Intense, intellectual, and devoted.", val: "F" },
                { txt: "I wear the pants in the relationship.", val: "G" }
            ]},
            { q: "When receiving bad news, you:", a: [
                { txt: "Process the data logically.", val: "A" },
                { txt: "Seek a hug immediately.", val: "B" },
                { txt: "Need a drink.", val: "C" },
                { txt: "Panic and call for help.", val: "D" },
                { txt: "Hide in a corner.", val: "E" },
                { txt: "Reason through the emotions.", val: "F" },
                { txt: "Get angry and fix the problem.", val: "G" }
            ]},
            { q: "Your fashion style is:", a: [
                { txt: "Layered t-shirts (one long, one short).", val: "A" },
                { txt: "Comfortable hoodies and jackets.", val: "B" },
                { txt: "Cute tops and jeans.", val: "C" },
                { txt: "Tight pants and giant belt buckles.", val: "D" },
                { txt: "Vests and sweater-vests.", val: "E" },
                { txt: "Conservative cardigans and skirts.", val: "F" },
                { txt: "Sweet dresses with a professional edge.", val: "G" }
            ]},
            { q: "At a party, you are:", a: [
                { txt: "Judging the adherence to social etiquette.", val: "A" },
                { txt: "Making sure everyone has a drink.", val: "B" },
                { txt: "Dancing on the table.", val: "C" },
                { txt: "Trying to do magic tricks.", val: "D" },
                { txt: "Standing silently near the food.", val: "E" },
                { txt: "Observing human mating rituals.", val: "F" },
                { txt: "Critiquing the catering.", val: "G" }
            ]},
            { q: "Your ultimate goal:", a: [
                { txt: "Winning a Nobel Prize.", val: "A" },
                { txt: "Being happy and loved.", val: "B" },
                { txt: "Being famous (or at least rich).", val: "C" },
                { txt: "Going to space.", val: "D" },
                { txt: "Finding true love.", val: "E" },
                { txt: "Changing the world through science.", val: "F" },
                { txt: "Being the boss.", val: "G" }
            ]}
        ];

        // --- RESULTS DATABASE ---
        const results = {
            "A": { title: "Sheldon Cooper", tags: ["#Genius", "#Bazinga", "#Logic"], desc: "You prioritize logic and consistency above all else. You thrive on routine, intellectual dominance, and rules. Social nuances confuse you, but your brilliance is unmatched.", power: "Eidetic Memory", weakness: "Sarcasm" },
            "B": { title: "Leonard Hofstadter", tags: ["#Heart", "#Physics", "#Loyal"], desc: "You are the emotional anchor of your group. Smart, kind, and empathetic, you bridge the gap between genius and reality. You sometimes doubt yourself, but you are the best friend anyone could ask for.", power: "Empathy", weakness: "Self-Doubt" },
            "C": { title: "Penny", tags: ["#StreetSmart", "#Social", "#Fun"], desc: "You possess superior social intelligence. While not an academic, you read people perfectly and handle chaos with wit and charm. You keep the geniuses grounded in the real world.", power: "Social Calibration", weakness: "Science Talk" },
            "D": { title: "Howard Wolowitz", tags: ["#Engineer", "#Space", "#Funny"], desc: "A brilliant engineer with a flair for the dramatic. You love gadgets, magic, and being the center of attention. You act tough, but you have a huge heart (and a loud mother).", power: "Engineering", weakness: "Maturity" },
            "E": { title: "Raj Koothrappali", tags: ["#Romantic", "#Astro", "#Sweet"], desc: "A sensitive soul who loves romance, fine food, and the stars. You feel deeply and care immensely, though you sometimes struggle to speak up for yourself.", power: "Romance", weakness: "Anxiety" },
            "F": { title: "Amy Farrah Fowler", tags: ["#Neuro", "#Tenacious", "#Growth"], desc: "Highly intelligent and tenaciously loyal. You approach life and relationships with scientific rigor. You are constantly evolving and pushing your boundaries.", power: "Tenacity", weakness: "Social Cues" },
            "G": { title: "Bernadette Rostenkowski", tags: ["#Boss", "#Scary", "#Cute"], desc: "Small but mighty. You are competitive, successful, and a little terrifying when angry. You are the one who actually gets things done.", power: "Intimidation", weakness: "Losing" }
        };

        // --- ENGINE ---
        let currentQuestion = 0;
        let scores = { A:0, B:0, C:0, D:0, E:0, F:0, G:0 };
        
        // --- NEW TRACKING VARS ---
        let startTime = 0;
        let ghostClickCount = 0;
        let validClickCount = 0;

        // --- NEW: GHOST CLICK TRACKER ---
        document.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('a')) {
                validClickCount++;
            } else {
                ghostClickCount++;
            }
        });

        function startQuiz() {
            startTime = Date.now();
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('quizInterface').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = questions[currentQuestion];
            document.getElementById('questionText').textContent = q.q;
            document.getElementById('progressText').textContent = `${currentQuestion + 1} / ${questions.length}`;
            document.getElementById('progressBar').style.width = `${((currentQuestion) / questions.length) * 100}%`;
            
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all text-slate-200 font-medium flex items-center group";
                btn.innerHTML = `<span class="w-6 h-6 rounded-full border border-slate-500 flex items-center justify-center text-xs mr-3 text-slate-500 group-hover:border-yellow-400 group-hover:text-yellow-400 transition">${String.fromCharCode(65+idx)}</span> ${opt.txt}`;
                btn.onclick = () => selectAnswer(opt.val);
                grid.appendChild(btn);
            });
        }

        function selectAnswer(val) {
            scores[val]++;
            currentQuestion++;
            if (currentQuestion < questions.length) loadQuestion();
            else showAnalyzing();
        }

        function showAnalyzing() {
            document.getElementById('quizInterface').classList.add('hidden');
            document.getElementById('analyzingScreen').classList.remove('hidden');
            const texts = ["CALCULATING IQ...", "FACTORING IN MOTHER ISSUES...", "ADJUSTING FOR SARCASM...", "FINALIZING ARCHETYPE..."];
            let step = 0;
            const interval = setInterval(() => {
                if (step < texts.length) {
                    document.getElementById('analyzingText').textContent = texts[step];
                    step++;
                } else {
                    clearInterval(interval);
                    showResult();
                }
            }, 800);
        }

        function showResult() {
            document.getElementById('analyzingScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            let max = 0;
            let winner = 'A';
            for (const [k, v] of Object.entries(scores)) {
                if (v > max) { max = v; winner = k; }
            }
            
            const r = results[winner];
            document.getElementById('resultTitle').textContent = r.title;
            document.getElementById('resultDesc').textContent = r.desc;
            document.getElementById('resultPower').textContent = r.power;
            document.getElementById('resultWeakness').textContent = r.weakness;
            
            const tags = document.getElementById('resultTags');
            tags.innerHTML = r.tags.map(t => `<span class="bg-white/10 px-3 py-1 rounded-full text-[10px] text-cyan-300 font-bold tracking-wider">${t}</span>`).join('');

            // --- SAVE TO DB (The Fix) ---
            const timeTaken = (Date.now() - startTime) / 1000;
            
            if (window.GameEngine) {
                // Flat XP Reward for Personality Test
                window.GameEngine.addXP(500);
                
                // Save the Result
                window.GameEngine.saveGameResult("TBBT Persona", 100, 10, {
                    result: r.title,
                    archetype: winner,
                    timeSpent: timeTaken,
                    ghostClicks: ghostClickCount
                });
            }

            // Call share setup
            setupResultShare(r.title, r.title);
        }
    </script>
</body>
</html>