<!DOCTYPE html>
<html lang="en">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-ML3F7KLZ');</script>
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
      }
    }
  </script>

  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="game-engine.js"></script>
  <script src="components.js" defer></script>
<script type="module" src="assets/ux-core.js"></script>

  <link rel="icon" type="image/png" sizes="192x192" href="assets/favicon-192.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>QuizRealm • History Timeline</title>

  <meta name="theme-color" content="#020617" />
  <meta name="description" content="Reconstruct the timeline. Drag and drop historical events into their correct chronological order." />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@300;400;500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <script src="HistoryTimeline.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
            arcade: ['Bungee', 'cursive'],
            mono: ['Share Tech Mono', 'monospace']
          },
          colors: {
            bgDark: '#0A0F1E',
            bgDarker: '#050810',
            accentGold: '#fbbf24',
            accentBlue: '#3b82f6',
            accentCyan: '#06b6d4',
            glass: 'rgba(30, 41, 59, 0.70)'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bgDark:#0A0F1E;
      --bgDarker:#050810;
      --glass: rgba(30, 41, 59, 0.70);
      --stroke: rgba(255,255,255,0.08);
      --gold:#fbbf24;
    }

    body{
      background-color: var(--bgDarker);
      background-image:
        radial-gradient(circle at 50% 0%, rgba(30,27,75,1), rgba(5,8,16,1) 75%),
        radial-gradient(circle at 12% 20%, rgba(59,130,246,0.14), transparent 55%),
        radial-gradient(circle at 88% 25%, rgba(6,182,212,0.10), transparent 60%);
      min-height: 100vh;
      color: #e2e8f0;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .glass-panel{
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--stroke);
      box-shadow: 0 18px 50px -40px rgba(0,0,0,0.8);
    }

    .app-shell{ width: 100%; max-width: 1200px; margin: 0 auto; padding: 16px; }
    @media (min-width: 768px){ .app-shell{ padding: 28px; } }

    .app-main{ display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .app-main{ grid-template-columns: 1.5fr 0.9fr; gap: 18px; } }

    .panel-head{ background: rgba(0,0,0,0.35); border-bottom: 1px solid var(--stroke); }
    .panel-foot{ background: rgba(0,0,0,0.35); border-top: 1px solid var(--stroke); }

    /* Timeline spine */
    .timeline-wrap{ position: relative; padding: 18px 16px 8px; }
    .timeline-wrap::before{
      content:''; position:absolute; top: 22px; bottom: 18px; left: 32px; width: 3px;
      background: linear-gradient(180deg, rgba(59,130,246,0.95), rgba(59,130,246,0.10)); opacity: 0.9;
    }
    @media (min-width: 768px){ .timeline-wrap{ padding: 22px 22px 10px; } .timeline-wrap::before{ left: 40px; width: 4px; } }

    /* Year badge */
    .year-badge{
      width: 70px; height: 70px; border-radius: 18px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.16), rgba(255,255,255,0.02) 55%), rgba(10,15,30,0.9);
      border: 1px solid rgba(59,130,246,0.55);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.15), 0 18px 38px -30px rgba(59,130,246,0.7);
      display:flex; align-items:center; justify-content:center; flex-direction: column; text-align:center; z-index: 2;
    }
    .year-badge .y{ font-family: 'Share Tech Mono', monospace; font-weight: 800; line-height: 1; font-size: 18px; color: #eaf2ff; }
    .year-badge .era{ margin-top: 6px; font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase; color: rgba(147,197,253,0.85); font-weight: 900; }
    @media (min-width: 768px){ .year-badge{ width: 84px; height: 84px; border-radius: 22px; } .year-badge .y{ font-size: 22px; } }

    /* Slot styling */
    .timeline-slot{
      background: rgba(0,0,0,0.26); border: 1px dashed rgba(255,255,255,0.18);
      transition: transform .15s ease, border-color .15s ease, background .15s ease; min-height: 78px;
    }
    .timeline-slot:hover{ border-color: rgba(251,191,36,0.55); background: rgba(255,255,255,0.04); transform: translateY(-1px); }
    .timeline-slot.correct{ border-color: rgba(16,185,129,0.85); border-style: solid; background: rgba(16,185,129,0.08); }
    .timeline-slot.incorrect{ border-color: rgba(239,68,68,0.85); border-style: solid; background: rgba(239,68,68,0.08); }

    .event-card.selected{
      border-color: rgba(251,191,36,0.75) !important;
      box-shadow: 0 0 0 1px rgba(251,191,36,0.15), 0 14px 30px -22px rgba(251,191,36,0.8);
      background: linear-gradient(135deg, rgba(30,41,59,0.96), rgba(15,23,42,0.96));
    }

    /* Result Modal Stats */
    .stat-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
  </style>
</head>

<body class="flex flex-col antialiased selection:bg-accentGold selection:text-black">
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-ML3F7KLZ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <quiz-header></quiz-header>

  <div class="app-shell">
    <section class="glass-panel rounded-2xl overflow-hidden border border-white/10">
      <div class="grid grid-cols-1 md:grid-cols-2">
        <div class="p-6 md:p-8">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-white/5 text-[10px] uppercase tracking-[0.35em] text-slate-300">
            <i class="fas fa-hourglass-half text-accentGold"></i> Chronology Puzzle
          </div>
          <h1 class="font-arcade text-3xl md:text-4xl text-white mt-4 leading-tight">
            HISTORY <span class="text-accentGold">TIMELINE</span>
          </h1>
          <p class="text-slate-300/90 mt-3 text-sm md:text-base leading-relaxed max-w-xl">
            Place events into the correct year. Complete the timeline to earn XP.
          </p>
        </div>
      </div>
    </section>

    <main class="app-main mt-4">
      <section class="glass-panel rounded-2xl overflow-hidden border border-white/10 flex flex-col">
        <div class="panel-head px-4 md:px-6 py-4 flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-blue-500/15 border border-blue-400/25 text-blue-200 flex items-center justify-center font-black">1</div>
            <div>
              <div class="text-white font-extrabold tracking-wide">Target Timeline</div>
              <div class="text-[11px] text-slate-400 uppercase tracking-widest">Fill every slot</div>
            </div>
          </div>
          <div class="px-3 py-2 rounded-full bg-black/35 border border-white/10">
            <span id="scoreDisplay" class="text-accentGold font-mono font-black text-sm">0/6 PLACED</span>
          </div>
        </div>

        <div id="timelineScroll" class="flex-1 overflow-y-auto">
          <div class="timeline-wrap" id="timelineContainer"></div>
        </div>

        <div class="panel-foot px-4 md:px-6 py-4 flex flex-col sm:flex-row gap-3 justify-between">
          <button onclick="resetRound()" class="w-full sm:w-auto px-4 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-slate-200 font-bold uppercase text-xs tracking-widest transition flex items-center justify-center gap-2">
            <i class="fas fa-rotate-left"></i> Reset
          </button>

          <button onclick="checkAnswers()" class="w-full sm:w-auto px-14 py-5 rounded-xl font-black uppercase tracking-widest text-bg text-black bg-gradient-to-r from-accentGold to-yellow-500 hover:from-yellow-300 hover:to-yellow-600 transition shadow-[0_0_22px_rgba(251,191,36,0.28)] hover:shadow-[0_0_32px_rgba(251,191,36,0.42)] flex items-center justify-center gap-2">
            Verify Timeline <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </section>

      <aside class="glass-panel rounded-2xl overflow-hidden border border-white/10 flex flex-col min-h-[420px]">
        <div class="panel-head px-4 md:px-5 py-4">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-slate-500/15 border border-white/10 text-slate-200 flex items-center justify-center font-black">2</div>
              <div>
                <div class="text-white font-extrabold tracking-wide">Events</div>
                <div class="text-[11px] text-slate-400 uppercase tracking-widest">Select Difficulty</div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex bg-black/35 p-1.5 rounded-xl border border-white/10">
              <button onclick="setDifficulty('easy')" id="btnEasy" class="diff-btn flex-1 px-3 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition bg-accentGold text-black shadow-lg">Easy</button>
              <button onclick="setDifficulty('medium')" id="btnMedium" class="diff-btn flex-1 px-3 py-3 rounded-lg text-xs font-black uppercase tracking-widest text-slate-300 hover:text-white transition">Medium</button>
              <button onclick="setDifficulty('hard')" id="btnHard" class="diff-btn flex-1 px-3 py-3 rounded-lg text-xs font-black uppercase tracking-widest text-slate-300 hover:text-white transition">Hard</button>
            </div>
          </div>
        </div>

        <div id="selectedBar" class="selected-bar hidden px-4 py-3 bg-slate-900 border-b border-white/10">
          <div class="flex items-center justify-between gap-2">
            <div class="text-[11px] uppercase tracking-widest font-black text-slate-300">
              Selected: <span id="selectedLabel" class="text-accentGold">—</span>
            </div>
            <button onclick="clearSelected()" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-slate-200 text-[11px] font-black uppercase tracking-widest hover:bg-white/10 transition">
              Clear
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto pool-scroll bg-black/20 p-4" id="eventPool"></div>
      </aside>
    </main>

    <div id="resultModal" class="fixed inset-0 bg-bgDarker/95 z-[100] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
      <div class="w-full max-w-md bg-[#0f1219] border border-white/10 p-8 rounded-3xl text-center relative overflow-hidden animate-pop-in">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-32 bg-accentGold/20 rounded-full blur-[80px] -z-10"></div>

        <i class="fas fa-check-circle text-5xl text-accentGold mb-4 drop-shadow-[0_0_15px_rgba(251,191,36,0.5)]"></i>
        
        <h2 class="text-3xl font-arcade text-white mb-1">TIMELINE RESTORED</h2>
        <p class="text-slate-400 text-xs uppercase tracking-[0.2em] mb-6">Historical Sequence Verified</p>

        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="stat-box">
                <div class="text-[9px] text-slate-500 font-bold uppercase">Attempts</div>
                <div class="text-xl text-white font-mono" id="resAttempts">1</div>
            </div>
            <div class="stat-box">
                <div class="text-[9px] text-slate-500 font-bold uppercase">Time</div>
                <div class="text-xl text-white font-mono" id="resTime">0s</div>
            </div>
            <div class="stat-box">
                <div class="text-[9px] text-slate-500 font-bold uppercase">XP Earned</div>
                <div class="text-xl text-accentGold font-mono" id="resXP">+0</div>
            </div>
        </div>

        <button onclick="closeModalAndReset()" class="w-full py-4 bg-white text-black font-black text-sm uppercase tracking-widest rounded-xl hover:bg-slate-200 transition shadow-lg">
          Next Mission
        </button>
      </div>
    </div>
  </div>

  <quiz-footer></quiz-footer>

  <script>
    // --- FALLBACK DATA ---
    const FALLBACK_DB = [
      { id: 'e1', year: 1945, label: 'End of World War II' },
      { id: 'e2', year: 1969, label: 'Apollo 11 Moon Landing' },
      { id: 'e3', year: 1989, label: 'Fall of the Berlin Wall' },
      { id: 'e4', year: 2001, label: 'Launch of the First iPod' },
      { id: 'e5', year: 1776, label: 'Declaration of Independence' },
      { id: 'e6', year: 1492, label: 'Columbus Reaches Americas' },
      { id: 'e7', year: 1912, label: 'Sinking of the Titanic' },
      { id: 'e8', year: 1066, label: 'Battle of Hastings' },
      { id: 'e9', year: 1963, label: 'I Have a Dream Speech' },
      { id: 'e10', year: 2007, label: 'First iPhone Released' },
      { id: 'e11', year: 1928, label: 'Discovery of Penicillin' },
      { id: 'e12', year: 1865, label: 'Lincoln Assassinated' },
      { id: 'e13', year: -44, label: 'Assassination of Julius Caesar' },
      { id: 'e14', year: -2560, label: 'Great Pyramid of Giza Completed (approx.)' }
    ];

    // --- APP STATE ---
    const state = {
      events: [],
      placements: {},   // { slotIndex: eventId }
      difficulty: 'easy',
      selectedEventId: null
    };

    // --- TRACKING VARIABLES ---
    let startTime = 0;
    let verifyAttempts = 0;
    let ghostClickCount = 0;
    let validClickCount = 0;

    // --- CLICK TRACKER ---
    document.addEventListener('click', (e) => {
        if (e.target.closest('button') || e.target.closest('.event-card') || e.target.closest('.timeline-slot')) {
            validClickCount++;
        } else {
            ghostClickCount++;
        }
    });

    // --- YEAR FORMAT ---
    function formatYear(y){
      if (typeof y !== 'number') return { main: String(y), era: '' };
      if (y < 0) return { main: String(Math.abs(y)), era: 'BC' };
      return { main: String(y), era: '' }; 
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => initGame());

    function initGame() {
      setDifficultyStyle(state.difficulty);
      const count = state.difficulty === 'easy' ? 6 : (state.difficulty === 'medium' ? 8 : 10);

      // Reset Tracking
      startTime = Date.now();
      verifyAttempts = 0;
      state.placements = {};
      state.selectedEventId = null;
      state.events = [];

      // Load Data
      if (typeof HistoryTimeline !== 'undefined' && typeof HistoryTimeline.getRandomSet === 'function') {
        try { state.events = HistoryTimeline.getRandomSet(state.difficulty, count); } catch (e) {}
      }
      if (!state.events || state.events.length === 0) {
        const shuffled = [...FALLBACK_DB].sort(() => Math.random() - 0.5);
        state.events = shuffled.slice(0, count);
      }

      renderTimeline();
      renderEventPool();
      updateStats();
      updateSelectedBar();
    }

    // --- RENDERING LOGIC ---
    function renderTimeline() {
      const container = document.getElementById('timelineContainer');
      container.innerHTML = '';
      const sortedEvents = [...state.events].sort((a,b) => a.year - b.year);

      sortedEvents.forEach((ev, index) => {
        const placedId = state.placements[index];
        const placedEvent = placedId ? state.events.find(e => e.id === placedId) : null;
        const row = document.createElement('div');
        row.className = "timeline-row flex gap-4 md:gap-6 items-stretch mb-5 md:mb-7 relative z-10";

        const year = formatYear(ev.year);
        const badge = document.createElement('div');
        badge.className = 'year-badge shrink-0';
        badge.innerHTML = `<div class="y">${year.main}</div><div class="era">${year.era}</div>`;

        const slot = document.createElement('div');
        slot.className = `timeline-slot flex-1 rounded-2xl p-4 md:p-5 cursor-pointer select-none relative overflow-hidden ${placedEvent ? 'border-solid border-white/10 bg-slate-900/35' : ''}`;
        slot.dataset.index = index;
        slot.onclick = () => handleSlotClick(index);
        
        if (placedEvent) {
          slot.innerHTML = `
            <div class="flex items-start gap-3 w-full">
              <div class="w-1.5 h-12 bg-accentGold rounded-full mt-1"></div>
              <div class="flex-1">
                <div class="text-white font-extrabold tracking-wide text-sm md:text-base">${placedEvent.label}</div>
                <div class="text-slate-400 text-xs mt-1 font-mono tracking-wider uppercase">Placed</div>
              </div>
              <button class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 hover:bg-red-500/15 hover:text-red-300 transition flex items-center justify-center" onclick="event.stopPropagation(); removeEvent(${index})"><i class="fas fa-times"></i></button>
            </div>`;
        } else {
          const selected = state.selectedEventId ? state.events.find(e => e.id === state.selectedEventId) : null;
          slot.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <div class="text-slate-300/90">
                <div class="text-xs font-black uppercase tracking-[0.25em] ${selected ? 'text-accentGold' : 'text-slate-400'}">${selected ? 'Tap to place here' : 'Drop event here'}</div>
                <div class="mt-2 text-slate-400 text-sm">${selected ? selected.label : '<span class="opacity-70">Choose an event from the list</span>'}</div>
              </div>
              <div class="w-11 h-11 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center"><i class="fas ${selected ? 'fa-bullseye text-accentGold' : 'fa-arrow-down text-slate-300'}"></i></div>
            </div>`;
        }
        row.appendChild(badge);
        row.appendChild(slot);
        container.appendChild(row);
      });
    }

    function renderEventPool() {
      const pool = document.getElementById('eventPool');
      pool.innerHTML = '';
      const unplaced = state.events.filter(ev => !Object.values(state.placements).includes(ev.id));

      if (unplaced.length === 0) {
        pool.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center py-10 opacity-80"><i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i><div class="text-white font-black tracking-wide">All events placed</div></div>`;
        return;
      }

      unplaced.forEach(ev => {
        const card = document.createElement('div');
        card.className = `event-card rounded-2xl p-4 border border-white/10 bg-slate-900/35 hover:bg-slate-800/50 flex items-start gap-3 cursor-pointer ${state.selectedEventId === ev.id ? 'selected' : ''}`;
        card.onclick = () => handleCardClick(ev.id);
        card.innerHTML = `<div class="w-10 h-10 rounded-2xl bg-blue-500/10 border border-blue-400/20 flex items-center justify-center shrink-0 mt-0.5"><i class="fas fa-scroll text-blue-200"></i></div><div class="flex-1"><div class="text-white font-extrabold text-sm md:text-base leading-snug">${ev.label}</div><div class="text-slate-400 text-xs mt-2 font-mono uppercase tracking-wider">${state.selectedEventId === ev.id ? '<span class="text-accentGold">Selected • tap a slot</span>' : 'Tap to select'}</div></div>`;
        pool.appendChild(card);
      });
    }

    // --- INTERACTION ---
    function handleCardClick(eventId) {
      state.selectedEventId = (state.selectedEventId === eventId) ? null : eventId;
      updateSelectedBar();
      renderEventPool();
      renderTimeline();
    }

    function handleSlotClick(index) {
      if (state.selectedEventId) placeEvent(state.selectedEventId, index);
    }

    function placeEvent(eventId, slotIndex) {
      const existingSlot = Object.keys(state.placements).find(k => state.placements[k] === eventId);
      if (existingSlot !== undefined) delete state.placements[existingSlot];
      state.placements[slotIndex] = eventId;
      state.selectedEventId = null;
      updateSelectedBar();
      renderTimeline();
      renderEventPool();
      updateStats();
    }

    function removeEvent(slotIndex) {
      delete state.placements[slotIndex];
      renderTimeline();
      renderEventPool();
      updateStats();
    }

    function updateStats() {
      const total = state.events.length;
      const placed = Object.keys(state.placements).length;
      document.getElementById('scoreDisplay').innerText = `${placed}/${total} PLACED`;
    }

    function clearSelected(){
      state.selectedEventId = null;
      updateSelectedBar();
      renderEventPool();
      renderTimeline();
    }

    function updateSelectedBar(){
      const bar = document.getElementById('selectedBar');
      const label = document.getElementById('selectedLabel');
      if (!state.selectedEventId){ bar.classList.add('hidden'); return; }
      const ev = state.events.find(e => e.id === state.selectedEventId);
      label.textContent = ev ? ev.label : '—';
      bar.classList.remove('hidden');
    }

    function setDifficulty(level) {
      state.difficulty = level;
      initGame();
    }

    function setDifficultyStyle(level) {
      document.querySelectorAll('.diff-btn').forEach(btn => btn.className = "diff-btn flex-1 px-3 py-3 rounded-lg text-xs font-black uppercase tracking-widest text-slate-300 hover:text-white transition");
      const activeBtn = document.getElementById(`btn${level.charAt(0).toUpperCase() + level.slice(1)}`);
      if (activeBtn) activeBtn.className = "diff-btn flex-1 px-3 py-3 rounded-lg text-xs font-black uppercase tracking-widest transition bg-accentGold text-black shadow-lg";
    }

    function resetRound() {
      if(confirm("Reset the timeline?")) initGame();
    }

    // --- GAME LOGIC & SAVING ---
    function checkAnswers() {
      const total = state.events.length;
      const placed = Object.keys(state.placements).length;

      if (placed < total) { alert("Place all events before verifying."); return; }

      verifyAttempts++;
      let correctCount = 0;
      const correctOrder = [...state.events].sort((a,b) => a.year - b.year);

      correctOrder.forEach((correctEvent, index) => {
        const placedId = state.placements[index];
        const slotEl = document.querySelector(`.timeline-slot[data-index="${index}"]`);
        if (!slotEl) return;
        slotEl.classList.remove('correct', 'incorrect');
        if (placedId === correctEvent.id) {
          slotEl.classList.add('correct');
          correctCount++;
        } else {
          slotEl.classList.add('incorrect');
        }
      });

      // WIN CONDITION
      if (correctCount === total) {
        const timeTaken = (Date.now() - startTime) / 1000;
        
        // Calculate Score & XP
        // Base XP: Easy(300), Medium(500), Hard(800)
        let baseXP = state.difficulty === 'easy' ? 300 : (state.difficulty === 'medium' ? 500 : 800);
        
        // Penalty: Lose 50 XP per extra attempt (min 50)
        let finalXP = Math.max(50, baseXP - ((verifyAttempts - 1) * 50));

        // Display Stats in Modal
        document.getElementById('resAttempts').textContent = verifyAttempts;
        document.getElementById('resTime').textContent = Math.round(timeTaken) + "s";
        document.getElementById('resXP').textContent = "+" + finalXP;

        // SAVE TO DB
        if (window.GameEngine) {
            window.GameEngine.addXP(finalXP);
            window.GameEngine.saveGameResult("History Timeline", finalXP, 1, {
                difficulty: state.difficulty,
                attempts: verifyAttempts,
                timeSpent: timeTaken,
                ghostClicks: ghostClickCount
            });
            
            // Achievement Check
            if(verifyAttempts === 1) window.GameEngine.unlockAchievement("time_traveler");
        }

        setTimeout(() => document.getElementById('resultModal').classList.remove('hidden'), 450);
      }
    }

    function closeModalAndReset() {
      document.getElementById('resultModal').classList.add('hidden');
      initGame();
    }
  </script>
</body>
</html>