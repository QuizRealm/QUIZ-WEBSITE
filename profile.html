<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function(w,d,s,l,i){
            w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});
            var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
            j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-ML3F7KLZ');
    </script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:;">
<link rel="icon" type="image/png" sizes="192x192" href="assets/favicon-192.png">

    <script src="game-engine.js"></script>
    <script type="module" src="firebase-config.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizRealm â€¢ Player Profile</title>
    <meta name="theme-color" content="#0A0F1E">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="components.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        arcade: ['Bungee', 'cursive']
                    },
                    colors: {
                        bgDark: '#0A0F1E',
                        bgDarker: '#050810',
                        accentBlue: '#3b82f6',
                        accentCyan: '#06b6d4',
                        glass: 'rgba(30, 41, 59, 0.7)'
                    },
                    animation: {
                        'shimmer': 'shimmer 2s linear infinite'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050810;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .xp-bar-fill {
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6);
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-ML3F7KLZ"
                height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>

    <div class="fixed inset-0 z-[-1] opacity-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900 via-[#050810] to-[#050810]"></div>

    <quiz-header></quiz-header>

    <main class="flex-grow p-4 md:py-8 max-w-[1200px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <aside class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl overflow-hidden relative group">
                <div class="h-32 bg-blue-900 relative">
                    <img src="https://images.unsplash.com/photo-1535905557558-afc4877a26fc?q=80&w=800"
                         class="w-full h-full object-cover opacity-60" alt="Profile Banner">
                    <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] to-transparent"></div>
                </div>

                <div class="px-6 pb-6 relative -mt-16 text-center">
                    <div class="relative w-32 h-32 mx-auto mb-3 group/avatar">
                        <div class="w-full h-full rounded-full overflow-hidden border-4 border-[#050810] bg-slate-800 shadow-2xl relative">
                            <img id="profileAvatar"
                                 src="https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=Guest"
                                 class="w-full h-full object-cover transition duration-300"
                                 alt="Player Avatar">
                        </div>
                        <button onclick="window.randomizeAvatar()" 
                                class="absolute bottom-1 right-1 bg-white text-slate-900 hover:bg-blue-400 hover:text-white p-2 rounded-full shadow-lg border-2 border-[#050810] transition z-10"
                                title="New Look">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-center gap-2 mb-1">
                        <h1 class="text-2xl font-bold text-white" id="profileName">Guest Hero</h1>
                        <i class="fas fa-pen text-xs text-slate-500 hover:text-white cursor-pointer" 
                           onclick="document.getElementById('nicknameInput').focus()"
                           title="Edit name below"></i>
                    </div>
                    
                    <div class="text-sm font-bold text-cyan-400 mb-5" id="profileRank">Civilian</div>

                    <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2">
                            <span>PROGRESS</span>
                            <span id="profileXP" class="text-blue-400" id="profileXP">0 / 1000 XP</span>
                        </div>
                        <div class="w-full bg-slate-950 h-3 rounded-full overflow-hidden relative">
                            <div id="xpBarFill" class="xp-bar-fill h-full w-0 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-5 h-[320px] flex flex-col">
                <h3 class="text-sm font-bold text-white mb-4 uppercase tracking-wider text-slate-400">
                    <i class="fas fa-history mr-2"></i> Recent Activity
                </h3>
                <div id="activityLog" class="space-y-3 overflow-y-auto pr-2 flex-grow scrollbar-thin">
                    <div class="text-center text-xs text-slate-500 mt-10">Loading history...</div>
                </div>
            </div>
        </aside>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="grid grid-cols-3 gap-4">
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center hover:bg-white/5 transition">
                    <i class="fas fa-bolt text-yellow-400 text-2xl mb-2"></i>
                    <div class="text-2xl font-bold text-white" id="statScore">0</div>
                    <div class="text-[10px] uppercase font-bold text-slate-500">Total XP</div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center hover:bg-white/5 transition">
                    <i class="fas fa-fire text-orange-500 text-2xl mb-2"></i>
                    <div class="text-2xl font-bold text-white" id="statStreak">0</div>
                    <div class="text-[10px] uppercase font-bold text-slate-500">Daily Streak</div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center hover:bg-white/5 transition">
                    <i class="fas fa-award text-emerald-400 text-2xl mb-2"></i>
                    <div class="text-2xl font-bold text-white" id="statBadges">0</div>
                    <div class="text-[10px] uppercase font-bold text-slate-500">Achievements</div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">
                    <i class="fas fa-chart-pie mr-2"></i> Hero Skill Matrix
                </h3>
                <div id="skillMatrix" class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4"></div>
            </div>

            <div class="glass-panel p-6 rounded-xl relative overflow-hidden transition-all duration-300" id="authContainer">
                
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-white flex items-center gap-2" id="authTitle">
                            <i class="fas fa-id-card text-blue-500"></i> Identity Card
                        </h3>
                        <p id="authDesc" class="text-xs text-slate-400 mt-1 max-w-md">
                            Manage your hero identity and cloud save status.
                        </p>
                    </div>
                    <span id="authBadge" class="px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[10px] uppercase font-bold text-slate-400">
                        Guest
                    </span>
                </div>

                <div id="identityCard" class="bg-black/30 p-4 rounded-lg border border-white/5 mb-5">
                    <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block">
                        Choose Your Hero Nickname <span class="text-emerald-400">(Shown everywhere)</span>
                    </label>
                    <div class="flex gap-2 flex-col sm:flex-row">
                        <input id="nicknameInput" type="text" placeholder="Enter Hero Name..." maxlength="24"
                               class="flex-1 bg-slate-900 border border-slate-700 text-white text-sm rounded-lg p-3 focus:border-blue-500 focus:outline-none placeholder-slate-600">
                        <div class="flex gap-2">
                            <button onclick="window.generateCoolName()" 
                                    class="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded-lg border border-slate-600 transition flex items-center justify-center"
                                    title="Generate Funny Name">
                                <i class="fas fa-dice text-lg"></i>
                            </button>
                            <button onclick="window.saveGuestIdentity()" 
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-lg font-bold text-sm shadow-lg shadow-blue-500/20 transition">
                                Save
                            </button>
                        </div>
                    </div>
                    <p class="mt-2 text-[11px] text-slate-500">
                        <span class="font-bold text-emerald-400">Note:</span> Even if you sign in with Google, your <span class="font-semibold">nickname</span> is shown on the site, not your real name.
                    </p>
                </div>

                <div id="viewGuestAuth" class="space-y-4">
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-white/10"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-500 text-[10px] uppercase">Sync to Cloud</span>
                        <div class="flex-grow border-t border-white/10"></div>
                    </div>

                    <button onclick="handleGoogleLogin()"
                            class="w-full bg-white hover:bg-slate-100 text-slate-900 font-bold py-3 rounded-lg flex items-center justify-center gap-3 transition transform active:scale-[0.99]">
                        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                        Sign in with Google
                    </button>
                    
                    <div class="text-center">
                        <button onclick="document.getElementById('emailForm').classList.toggle('hidden')" 
                                class="text-xs text-slate-500 hover:text-slate-300 underline">
                            Or use email/password
                        </button>
                    </div>

                    <div id="emailForm" class="hidden space-y-3 pt-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input id="emailInput" type="email" placeholder="Email" class="bg-black/40 border border-white/10 text-white text-sm rounded-lg p-3">
                            <input id="passInput" type="password" placeholder="Password" class="bg-black/40 border border-white/10 text-white text-sm rounded-lg p-3">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="handleEmailLogin()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm font-bold">Sign In</button>
                            <button onclick="handleEmailSignup()" class="flex-1 bg-blue-900/50 hover:bg-blue-900 text-blue-200 py-2 rounded-lg text-sm font-bold">Register</button>
                        </div>
                    </div>
                    <div id="authError" class="text-red-400 text-xs font-bold hidden text-center"></div>
                </div>

                <div id="viewUser" class="hidden text-center py-6">
                    <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/30 shadow-[0_0_15px_rgba(74,222,128,0.2)]">
                        <i class="fas fa-wifi text-green-400 text-3xl"></i>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-white mb-1">YOU ARE CONNECTED</h3>
                    <p class="text-green-400 text-sm font-bold mb-4 tracking-wide uppercase">Cloud Sync Active</p>
                    
                    <div class="bg-white/5 rounded-lg p-4 max-w-sm mx-auto mb-6 text-left border border-white/5">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div>
                                <div class="text-[10px] text-slate-400 uppercase">Account Email</div>
                                <div id="userEmailDisplay" class="text-sm font-bold text-white truncate">user@example.com</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <div>
                                <div class="text-[10px] text-slate-400 uppercase">Player ID</div>
                                <div id="userIdDisplay" class="text-xs font-mono text-slate-300 truncate">...</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="handleLogout()"
                            class="text-red-400 hover:text-white hover:bg-red-600/80 border border-red-500/30 px-8 py-2 rounded-lg transition duration-300 text-sm font-bold">
                        Disconnect / Sign Out
                    </button>
                </div>
            </div>

        </div>
    </main>

    <quiz-footer></quiz-footer>

    <script type="module">
        /*********************************************************
         * SAFETY WRAPPER AROUND GameEngine.updateHeaderUI
         * to prevent infinite recursion with components.js
         *********************************************************/
        if (window.GameEngine) {
            const originalUpdateHeaderUI = typeof GameEngine.updateHeaderUI === "function"
                ? GameEngine.updateHeaderUI.bind(GameEngine)
                : null;

            GameEngine._headerUpdating = false;

            GameEngine.updateHeaderUI = function(...args) {
                if (GameEngine._headerUpdating) return;
                GameEngine._headerUpdating = true;
                try {
                    if (originalUpdateHeaderUI) {
                        originalUpdateHeaderUI(...args);
                    }
                } finally {
                    GameEngine._headerUpdating = false;
                }
            };
        }

        /*********************************************************
         * PROFILE / AUTH LOGIC
         *********************************************************/
        import {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- NAME GENERATOR LISTS ---
        const ADJECTIVES = ["Cosmic", "Iron", "Shadow", "Neon", "Dark", "Scarlet", "Quantum", "Electric", "Rogue", "Mystic", "Savage", "Phantom"];
        const NOUNS = ["Goblin", "Avenger", "Knight", "Wizard", "Falcon", "Panther", "Guardian", "Hunter", "Storm", "Viper", "Hawk", "Spectre", "Titan"];

        function buildRandomNickname() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const num = Math.floor(100000 + Math.random() * 900000); // 6-digit
            return `${adj} ${noun} #${num}`;
        }

        let currentUser = null;
        let currentAvatarSeed = localStorage.getItem("QR_AVATAR_SEED") || "Guest";
        let currentNickname = localStorage.getItem("QR_NICKNAME") || "Guest Hero";

        function ensureNickname() {
            const stored = localStorage.getItem("QR_NICKNAME");
            if (stored && stored.trim()) {
                currentNickname = stored.trim();
                return;
            }
            if (!currentNickname || currentNickname === "Guest Hero") {
                currentNickname = buildRandomNickname();
                try {
                    localStorage.setItem("QR_NICKNAME", currentNickname);
                } catch {}
            }
        }
        ensureNickname();

        window.generateCoolName = () => {
            const name = buildRandomNickname();
            const input = document.getElementById('nicknameInput');
            if (input) input.value = name;
        };

        window.randomizeAvatar = () => {
            const seed = Math.random().toString(36).substring(7);
            currentAvatarSeed = seed;
            updateAvatarDisplay();
            try {
                localStorage.setItem("QR_AVATAR_SEED", seed);
            } catch {}
        };

        window.saveGuestIdentity = async () => {
            const input = document.getElementById('nicknameInput');
            if (input && input.value.trim()) {
                currentNickname = input.value.trim();
                try {
                    localStorage.setItem("QR_NICKNAME", currentNickname);
                } catch {}
                updateProfileHeader();

                // If logged in, persist nickname to user's hero doc
                if (currentUser && window.db) {
                    try {
                        const userRef = doc(window.db, "heroes", currentUser.uid);
                        await setDoc(userRef, { nickname: currentNickname }, { merge: true });
                    } catch (e) {
                        console.warn("Failed to save nickname in Firestore:", e);
                    }
                }

                // Button feedback
                const btn = input.parentElement.querySelector('button:last-child');
                if (btn) {
                    const original = btn.textContent;
                    btn.textContent = "Saved!";
                    btn.classList.add("bg-green-600");
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.classList.remove("bg-green-600");
                    }, 1500);
                }
            }
        };

        function updateAvatarDisplay() {
            const img = document.getElementById('profileAvatar');
            if (img) img.src = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${encodeURIComponent(currentAvatarSeed)}`;
        }

        function updateProfileHeader() {
            const nameEl = document.getElementById('profileName');
            if (nameEl) nameEl.textContent = currentNickname;
        }

        function calculateLevel(xp) {
            if (xp >= 1000) return "Justice League Member";
            if (xp >= 500) return "Gotham Vigilante";
            if (xp >= 100) return "Sidekick";
            return "Civilian";
        }

        function updateStatsUI(xp, levelLabel, streak, badgeCount) {
            // 1. Get Level from Engine or calculate it locally if needed
            const currentLevel = window.GameEngine?.state?.level || Math.floor(Math.sqrt(xp / 100)) || 1;
            
            // 2. Calculate Math for Progress Bar (Quadratic Curve)
            const startXP = 100 * (currentLevel * currentLevel);      // XP needed to reach current level
            const nextXP  = 100 * ((currentLevel + 1) * (currentLevel + 1)); // XP needed for next level
            
            const range = nextXP - startXP;
            const progress = xp - startXP;
            const percent = Math.max(0, Math.min(100, (progress / range) * 100));

            // 3. Update Text (e.g., "450 / 900 XP")
            document.getElementById('profileXP').textContent = `${progress.toLocaleString()} / ${range.toLocaleString()} XP`;
            
            // 4. Update Bar Width
            document.getElementById('xpBarFill').style.width = `${percent}%`;

            // 5. Update Other Stats
            document.getElementById('profileRank').textContent = levelLabel;
            document.getElementById('statScore').textContent = xp.toLocaleString();
            document.getElementById('statStreak').textContent = streak;
            document.getElementById('statBadges').textContent = badgeCount;
        }
        function renderSkillMatrix(xp) {
            const matrix = document.getElementById('skillMatrix');
            const factor = Math.min(100, Math.log10(xp + 10) * 30);
            
            const skills = [
                { name: "DC Lore", val: factor,                   color: "bg-blue-500" },
                { name: "Marvel Lore", val: Math.max(10, factor - 10), color: "bg-red-500" },
                { name: "Villains",   val: Math.max(5,  factor - 5),  color: "bg-purple-500" },
                { name: "Weapons",    val: Math.max(15, factor - 15), color: "bg-yellow-500" }
            ];

            matrix.innerHTML = skills.map(s => `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs font-bold text-slate-300">${s.name}</span>
                        <span class="text-[10px] text-slate-500">${Math.round(s.val)}%</span>
                    </div>
                    <div class="w-full bg-black/40 h-2 rounded-full overflow-hidden">
                        <div class="${s.color} h-full rounded-full transition-all duration-1000" style="width: ${s.val}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderActivityLog(isLoggedIn, xp) {
            const log = document.getElementById('activityLog');
            let html = '';
            
            if (isLoggedIn) {
                html += `
                <div class="flex gap-3 items-center p-2 rounded hover:bg-white/5 transition border-l-2 border-green-500 bg-green-500/5">
                    <div class="w-8 h-8 rounded bg-slate-900 flex items-center justify-center text-green-400">
                        <i class="fas fa-plug"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-white">Online & Synced</div>
                        <div class="text-[10px] text-slate-500">Cloud save active</div>
                    </div>
                </div>`;
            } else {
                html += `
                <div class="flex gap-3 items-center p-2 rounded hover:bg-white/5 transition border-l-2 border-slate-600">
                    <div class="w-8 h-8 rounded bg-slate-900 flex items-center justify-center text-slate-400">
                        <i class="fas fa-ghost"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-white">Guest Session</div>
                        <div class="text-[10px] text-slate-500">Progress saved on this device only</div>
                    </div>
                </div>`;
            }

            if (xp > 0) {
                html += `
                <div class="flex gap-3 items-center p-2 rounded hover:bg-white/5 transition">
                    <div class="w-8 h-8 rounded bg-slate-900 flex items-center justify-center text-yellow-400">
                        <i class="fas fa-star"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-white">Gaining Experience</div>
                        <div class="text-[10px] text-slate-500">Total XP: ${xp}</div>
                    </div>
                </div>`;
            }

            log.innerHTML = html;
        }

        function loadLocalProgress() {
            let xp = parseInt(localStorage.getItem('QR_XP')) || 0;
            if (window.GameEngine && typeof GameEngine.xp === "number") xp = GameEngine.xp;
            
            const level = calculateLevel(xp);
            const streak = parseInt(localStorage.getItem('QR_STREAK')) || 0;
            const badges = (window.GameEngine && GameEngine.badges && GameEngine.badges.size) || 0;
            
            updateStatsUI(xp, level, streak, badges);
            renderSkillMatrix(xp);
            renderActivityLog(false, xp);
        }

        async function syncUserData(user) {
            if (!window.db) return;
            const userRef = doc(window.db, "heroes", user.uid);
            
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    const data = snap.data();

                    if (window.GameEngine) {
                        GameEngine.xp = data.xp || GameEngine.xp || 0;
                        GameEngine.streak = data.streak || GameEngine.streak || 0;
                    }
                    
                    const xp = window.GameEngine?.xp || data.xp || 0;
                    const streak = window.GameEngine?.streak || data.streak || 0;
                    const levelLabel = data.level || calculateLevel(xp);
                    const badgeCount = data.badges?.length || (window.GameEngine?.badges?.size || 0);

                    // nickname priority: Firestore -> local -> generated
                    if (data.nickname && data.nickname.trim()) {
                        currentNickname = data.nickname.trim();
                        try { localStorage.setItem("QR_NICKNAME", currentNickname); } catch {}
                    } else {
                        ensureNickname();
                        await setDoc(userRef, { nickname: currentNickname }, { merge: true });
                    }

                    updateProfileHeader();
                    updateStatsUI(xp, levelLabel, streak, badgeCount);
                    renderSkillMatrix(xp);
                    renderActivityLog(true, xp);
                } else {
                    ensureNickname();
                    const xp = window.GameEngine?.xp || 0;
                    await setDoc(userRef, {
                        email: user.email,
                        xp,
                        level: calculateLevel(xp),
                        streak: 0,
                        nickname: currentNickname
                    }, { merge: true });
                }
            } catch (e) {
                console.error("Sync Error", e);
            }
        }

        function renderLoggedInState(user) {
            document.getElementById('viewGuestAuth').classList.add('hidden');
            document.getElementById('viewUser').classList.remove('hidden');

            const badge = document.getElementById('authBadge');
            badge.textContent = "SECURE";
            badge.className = "px-2 py-1 rounded bg-green-900/50 border border-green-500/30 text-[10px] uppercase font-bold text-green-400";
            
            document.getElementById('authTitle').innerHTML = `<i class="fas fa-check-circle text-green-500"></i> Account Verified`;
            document.getElementById('authDesc').textContent = "Your stats are syncing in real-time.";

            document.getElementById('userEmailDisplay').textContent = user.email || "Google Account";
            document.getElementById('userIdDisplay').textContent = user.uid;

            ensureNickname();
            updateProfileHeader();

            if (user.photoURL) {
                document.getElementById('profileAvatar').src = user.photoURL;
            } else {
                updateAvatarDisplay();
            }
        }

        function renderGuestState() {
            document.getElementById('viewGuestAuth').classList.remove('hidden');
            document.getElementById('viewUser').classList.add('hidden');

            const badge = document.getElementById('authBadge');
            badge.textContent = "GUEST";
            badge.className = "px-2 py-1 rounded bg-slate-800 border border-slate-600 text-[10px] uppercase font-bold text-slate-400";

            document.getElementById('authTitle').innerHTML = `<i class="fas fa-id-card text-blue-500"></i> Identity Card`;
            document.getElementById('authDesc').textContent = "Manage your hero identity and cloud save status.";

            ensureNickname();
            const nickInput = document.getElementById('nicknameInput');
            if (nickInput) nickInput.value = currentNickname;
            updateAvatarDisplay();
            updateProfileHeader();
        }

        async function initAuthObserver() {
            const checkAuth = setInterval(() => {
                if (window.auth) {
                    clearInterval(checkAuth);
                    
                    onAuthStateChanged(window.auth, async (user) => {
                        currentUser = user;
                        
                        // FIX: Only show "Logged In" screen if NOT anonymous
                        if (user && !user.isAnonymous) {
                            console.log("User is Secure/Registered");
                            renderLoggedInState(user);
                            await syncUserData(user);
                        } else {
                            console.log("User is Guest/Anonymous");
                            renderGuestState(); // Show Google/Email buttons
                            loadLocalProgress();
                        }
                    });
                }
            }, 100);
        }

        const provider = new GoogleAuthProvider();

        window.handleGoogleLogin = async () => {
            try {
                await signInWithPopup(window.auth, provider);
            } catch (error) {
                const el = document.getElementById('authError');
                if (el) {
                    el.textContent = error.message;
                    el.classList.remove('hidden');
                }
            }
        };

        window.handleEmailLogin = async () => {
            const e = document.getElementById('emailInput').value;
            const p = document.getElementById('passInput').value;
            if (!e || !p) return;
            try {
                await signInWithEmailAndPassword(window.auth, e, p);
            } catch (err) {
                const el = document.getElementById('authError');
                if (el) {
                    el.textContent = "Login Failed: " + err.message;
                    el.classList.remove('hidden');
                }
            }
        };

        window.handleEmailSignup = async () => {
            const e = document.getElementById('emailInput').value;
            const p = document.getElementById('passInput').value;
            if (!e || !p) return;
            try {
                await createUserWithEmailAndPassword(window.auth, e, p);
            } catch (err) {
                const el = document.getElementById('authError');
                if (el) {
                    el.textContent = "Signup Failed: " + err.message;
                    el.classList.remove('hidden');
                }
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(window.auth);
            } catch (e) {
                console.error("Signout error:", e);
            }
            // Extra safety: clear Firebase auth cache in localStorage for dev/live-server
            try {
                Object.keys(localStorage).forEach(k => {
                    if (k.startsWith('firebase:authUser:') || k.startsWith('firebase:authDomain:')) {
                        localStorage.removeItem(k);
                    }
                });
            } catch {}
            // Keep nickname/avatar, just force UI refresh
            window.location.reload();
        };

        // Init
        initAuthObserver();
        loadLocalProgress();
        updateAvatarDisplay();
        updateProfileHeader();
    </script>
</body>
</html>